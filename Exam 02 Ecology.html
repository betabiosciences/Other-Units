<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetaBiosciences Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the quiz app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
            color: #333;
        }

        .quiz-container {
            background-color: #ffffff; /* White background for the quiz card */
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 32px; /* Increased padding */
            max-width: 800px; /* Increased max width for more content */
            width: 100%; /* Full width on smaller screens */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 24px; /* Space between sections */
            position: relative; /* For absolute positioning of footer */
        }

        .hidden {
            display: none !important; /* Use !important to override other display properties */
        }

        /* Login and Notice Page Styles */
        .page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Ensure pages have some height */
        }

        .input-field {
            padding: 12px 16px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #6366f1;
        }

        .action-button {
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: #ffffff;
            background-color: #4f46e5; /* Indigo */
        }

        .action-button:hover:not(:disabled) {
            background-color: #4338ca; /* Darker indigo */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .action-button:disabled {
            background-color: #9ca3af; /* Gray for disabled */
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Notice Page Specifics */
        .notice-title {
            font-size: 2rem;
            font-weight: 800;
            color: #ef4444; /* Red for important */
            margin-bottom: 20px;
        }

        .notice-list {
            list-style: none; /* Removed default numbering/bullets */
            padding: 0;
            margin: 0 0 30px 0;
            text-align: left;
            width: 100%;
            max-width: 450px;
        }

        .notice-list li {
            font-size: 1.1rem;
            margin-bottom: 10px;
            line-height: 1.5;
            position: relative; /* For custom bullets */
            padding-left: 20px; /* Space for custom bullet */
        }

        .notice-list li::before {
            content: "\2022"; /* Unicode for a bullet point */
            color: #ef4444; /* Red bullet */
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
            position: absolute;
            left: 0;
            top: 0;
        }


        .notice-list strong {
            color: #ef4444; /* Red for bold parts */
        }

        /* Quiz Page Layout */
        #quiz-page {
            display: grid;
            grid-template-columns: 1fr 200px; /* Main content and sidebar */
            gap: 30px;
            text-align: left;
            min-height: 400px; /* Ensure sufficient height for the grid layout */
        }

        #quiz-main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #quiz-sidebar {
            background-color: #f8fafc; /* Lightest gray for sidebar */
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Timer Styles */
        #timer-display {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #22c55e; /* Green */
            text-align: center;
            width: 100%;
            grid-column: 1 / -1; /* Span across both columns */
        }

        #timer-display.orange {
            color: #f97316; /* Orange */
        }

        #timer-display.red {
            color: #ef4444; /* Red */
        }

        .question-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: left; /* Align question text left */
        }

        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-button {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 500;
            border: 2px solid transparent;
            text-align: left; /* Align options left */
        }

        .option-button:hover {
            background-color: #cbd5e0;
        }

        .option-button.selected {
            background-color: #6366f1;
            color: #ffffff;
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        /* New styles for answer key options */
        .option-button.correct-answer {
            background-color: #22c55e; /* Green */
            color: #ffffff;
            border-color: #16a34a;
            pointer-events: none; /* Disable clicks */
        }

        .option-button.incorrect-answer {
            background-color: #ef4444; /* Red */
            color: #ffffff;
            border-color: #dc2626;
            pointer-events: none; /* Disable clicks */
        }

        .option-button.disabled-for-answer-key {
            pointer-events: none; /* Disable clicks */
            opacity: 0.7; /* Slightly dim non-highlighted options */
        }


        .quiz-nav-buttons {
            display: flex;
            justify-content: flex-start; /* Align buttons to the left */
            gap: 12px;
            margin-top: 20px;
        }

        .quiz-nav-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .quiz-nav-button.save-next {
            background-color: #10b981; /* Green */
            color: #ffffff;
        }
        .quiz-nav-button.save-next:hover { background-color: #059669; }

        .quiz-nav-button.clear {
            background-color: #f59e0b; /* Amber */
            color: #ffffff;
        }
        .quiz-nav-button.clear:hover { background-color: #d97706; }

        .quiz-nav-button.next {
            background-color: #3b82f6; /* Blue */
            color: #ffffff;
        }
        .quiz-nav-button.next:hover { background-color: #2563eb; }

        .quiz-nav-button.submit-quiz {
            background-color: #ef4444; /* Red */
            color: #ffffff;
        }
        .quiz-nav-button.submit-quiz:hover { background-color: #dc2626; }

        /* Answer Key Navigation Buttons */
        .answer-key-nav-buttons {
            display: flex;
            justify-content: space-between; /* Space out prev/next */
            gap: 12px;
            margin-top: 20px;
        }

        .answer-key-nav-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            background-color: #6366f1; /* Indigo */
            color: #ffffff;
        }
        .answer-key-nav-button:hover:not(:disabled) {
            background-color: #4f46e5;
        }
        .answer-key-nav-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Specific style for the "Close Answer Key" button */
        .answer-key-nav-button.close-answer-key {
            background-color: #ef4444; /* Red */
        }
        .answer-key-nav-button.close-answer-key:hover:not(:disabled) {
            background-color: #dc2626; /* Darker red */
        }


        /* Legend and Palette Styles */
        .legend-box {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: left;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .legend-color-box.red-ball {
            background-color: transparent; /* No background for 3D ball */
            color: #ef4444; /* Red for the icon */
            font-size: 1.2rem;
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-color-box.grey {
            background-color: #d1d5db; /* Grey */
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            border-radius: 5px;
            margin-right: 10px;
        }
        .legend-color-box.green {
            background-color: #22c55e; /* Green */
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            border-radius: 5px;
            margin-right: 10px;
        }


        #question-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .palette-box {
            background-color: #d1d5db; /* Grey (not visited) */
            color: #333;
            padding: 10px 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Make boxes square */
        }

        .palette-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .palette-box.unanswered {
            background-color: #ef4444; /* Red */
            color: #ffffff;
        }

        .palette-box.answered {
            background-color: #22c55e; /* Green */
            color: #ffffff;
        }

        /* Results Page Styles */
        .results-container { /* This class is not used, but styles below target elements within #final-results-page */
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            text-align: center;
        }

        .results-detail {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .results-detail strong {
            color: #4f46e5;
        }

        .telegram-link {
            color: #4f46e5;
            text-decoration: underline;
            font-weight: 600;
            margin-top: 20px;
            display: inline-block;
        }

        /* Admin Section Styles (Updated for internal positioning) */
        .admin-section {
            text-align: center;
            width: 100%; /* Take full width of parent */
            padding-top: 20px; /* Space from elements above it */
            margin-top: 20px; /* Space from elements above it */
            border-top: 1px solid #e2e8f0; /* Separator */
            background-color: #f8fafc; /* Light background */
            border-radius: 0 0 16px 16px; /* Match container bottom radius */
            padding-bottom: 10px; /* Padding at the bottom */
        }

        .admin-section h3 {
            font-size: 0.8rem; /* Smaller heading */
            font-weight: 700;
            margin-bottom: 10px; /* Smaller margin */
            color: #4f46e5;
        }

        .admin-login-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* Smaller gap */
        }

        /* Specific styles for admin input and button */
        .admin-login-area input.input-field {
            width: 80%; /* Take full width of its container */
            max-width: 200px; /* Smaller max-width */
            font-size: 0.85rem; /* Smaller font */
            padding: 8px 10px; /* Smaller padding */
            margin-bottom: 0; /* Remove bottom margin as gap handles spacing */
        }

        .admin-login-area button.action-button {
            padding: 8px 16px; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font size */
        }

        .admin-login-message {
            color: #ef4444;
            font-weight: 500;
            margin-top: 5px;
            margin-bottom: 0;
            font-size: 0.75rem;
        }

        /* Admin Results Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 800px; /* Slightly narrower than full admin page */
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for content */
            position: relative;
            text-align: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 25px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2.5rem;
            color: #666;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .close-button:hover {
            color: #333;
        }

        /* Styles for the table inside the modal */
        .admin-results-table-wrapper {
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto; /* Ensure horizontal scroll on small screens */
        }

        .admin-results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: left;
        }

        .admin-results-table th,
        .admin-results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .admin-results-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .admin-results-table tbody tr:hover {
            background-color: #f0f2f5;
        }

        .admin-results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .loading-message, .error-message, .no-results-message {
            font-size: 1.1rem;
            color: #6b7280;
            margin-top: 20px;
        }

        .error-message {
            color: #ef4444;
            font-weight: 600;
        }

        /* Footer */
        .app-footer {
            position: absolute;
            bottom: 10px; /* Keep it slightly above the very bottom */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #9ca3af; /* Grey color */
            user-select: none; /* Prevent selection for integrity check */
            white-space: nowrap; /* Keep on one line */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #quiz-page {
                grid-template-columns: 1fr; /* Stack main content and sidebar */
            }
            #quiz-sidebar {
                order: -1; /* Move sidebar to top on small screens */
                margin-bottom: 20px;
            }
            .quiz-container {
                padding: 24px;
                margin: 10px;
            }
            .question-text {
                font-size: 1.5rem;
            }
            .option-button, .quiz-nav-button, .action-button {
                font-size: 1rem;
                padding: 12px 16px;
            }
            .quiz-nav-buttons {
                flex-wrap: wrap; /* Allow buttons to wrap */
                justify-content: center;
            }
            .quiz-nav-button {
                flex-basis: 48%; /* Make buttons take roughly half width when wrapped */
            }
            .notice-title {
                font-size: 1.75rem;
            }
            .notice-list li {
                font-size: 1rem;
            }
            .admin-section {
                position: static; /* Remove absolute positioning on small screens */
                width: auto; /* Allow it to take full width */
                margin-top: 30px; /* Add some top margin */
                padding: 20px;
                box-shadow: none; /* Remove shadow to blend better */
                border-top: 1px solid #e2e8f0; /* Add border back */
                border-radius: 0; /* Remove border radius */
            }
            .admin-login-area input.input-field {
                max-width: 100%; /* Allow full width */
            }
            /* Responsive adjustments for modal */
            .modal-content {
                padding: 20px;
                width: 95%; /* Adjust width for smaller screens */
            }
            .modal-title {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            .admin-results-table th,
            .admin-results-table td {
                padding: 8px 10px;
                font-size: 0.75rem; /* Smaller font in table for mobile */
            }
            .close-button {
                font-size: 2rem;
                top: 10px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="quiz-app" class="quiz-container">
        <div id="login-page" class="page-content">
            <h2 class="question-text">Welcome to the Quiz!</h2>
            <p class="mb-4">Please enter your name to begin.</p>
            <input type="text" id="student-name-input" class="input-field" placeholder="Your Name">
            <button id="start-quiz-button" class="action-button" disabled>START</button>

            <div class="admin-section">
                <h3>Admin Login</h3>
                <div class="admin-login-area">
                    <input type="password" id="admin-passcode-input" class="input-field" placeholder="Enter Admin Passcode">
                    <button id="admin-login-button" class="action-button">Login as Admin</button>
                    <p id="admin-login-message" class="admin-login-message hidden"></p>
                </div>
            </div>
        </div>

        <div id="notice-page" class="page-content hidden">
            <h2 class="notice-title">IMPORTANT NOTICE</h2>
            <ul class="notice-list">
                <li>Each question carries <strong>2 marks</strong>.</li>
                <li>There will be <strong><span style="font-size: 1.2em;">NEGATIVE MARKING</span></strong> for incorrect answers.</li>
                <li>Penalty for incorrect answer is <strong>0.5 marks (25%)</strong>.</li>
                <li>Remember to click <span class="text-red-500 font-bold">Save & Next</span> to confirm your answer.</li>
            </ul>
            <button id="continue-quiz-button" class="action-button">Continue</button>
        </div>

        <div id="quiz-page" class="hidden">
            <div id="timer-display">05:00</div>
            <div id="quiz-main-content">
                <img id="question-image" class="question-image hidden" alt="Question Image">
                <h2 id="question-text" class="question-text"></h2>
                <div id="options-container" class="options-container">
                    </div>
                <div class="quiz-nav-buttons">
                    <button id="save-next-button" class="quiz-nav-button save-next">Save & Next</button>
                    <button id="clear-button" class="quiz-nav-button clear">Clear</button>
                    <button id="next-button" class="quiz-nav-button next">Next</button>
                </div>
                <div class="answer-key-nav-buttons hidden">
                    <button id="prev-answer-key-button" class="answer-key-nav-button">Previous</button>
                    <button id="next-answer-key-button" class="answer-key-nav-button">Next</button>
                </div>
            </div>
            <div id="quiz-sidebar">
                <div class="legend-box">
                    <h3 class="font-bold text-lg mb-3">Legend</h3>
                    <div class="legend-item">
                        <div class="legend-color-box red-ball"><i class="fas fa-circle"></i></div>
                        <span>Unanswered Questions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box grey"></div>
                        <span>Not Visited Questions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box green"></div>
                        <span>Answered Questions</span>
                    </div>
                </div>
                <div id="question-palette">
                    </div>
            </div>
        </div>

        <div id="final-results-page" class="page-content hidden">
            <h2 class="question-text">Quiz Results for <span id="student-name-display"></span></h2>
            <p class="results-detail">Questions Attempted: <strong id="attempted-display">0</strong></p>
            <p class="results-detail">Correct Answers: <strong id="correct-display">0</strong></p>
            <p class="results-detail">Incorrect Answers: <strong id="incorrect-display">0</strong></p>
            <p class="results-detail text-2xl mt-4">Total Score: <strong id="final-score-display">0</strong></p>
            <p class="results-detail">Maximum Marks: <strong id="max-marks-display">0</strong></p>
            <button id="show-answer-key-button" class="action-button mt-4">Answer Key</button>
        </div>

        <div id="admin-results-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="close-admin-modal" class="close-button">&times;</button>
                <h2 class="modal-title">All Quiz Results</h2>
                <div id="admin-results-display-area" class="admin-results-table-wrapper">
                    <p class="loading-message">Loading results...</p>
                    </div>
            </div>
        </div>

        <div id="app-footer" class="app-footer">betabiosciences@gmail.com</div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyCQMXeU6OJw2e5A-tPQFeoi8MO8ZZfY0WQ",
            authDomain: "beta-quizapp.firebaseapp.com",
            projectId: "beta-quizapp",
            storageBucket: "beta-quizapp.firebasestorage.app",
            messagingSenderId: "709439478022",
            appId: "1:709439478022:web:595f257edbade7d458a687",
            measurementId: "G-5WF35EM4YB"
        };

        const projectIdForFirestorePath = firebaseConfig.projectId;

        let app, db, auth, userId;
        let isAuthReady = false;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        isAuthReady = true;
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Anonymous Auth failed:", error);
                            adminLoginMessage.textContent = "Firebase authentication failed. Cannot load results.";
                            adminLoginMessage.classList.remove('hidden');
                            adminLoginMessage.style.color = '#ef4444';
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                adminLoginMessage.textContent = "Firebase initialization failed. Cannot load results.";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#ef4444';
            }
        }
        initFirebase();

        // --- Quiz Data ---
        const quizData = [
            {
        question: "A team of researchers is studying two closely related species of finches, Species A and Species B, on an island. They measure the beak size of individuals from both species in two different locations: a sympatric zone where both species coexist, and an allopatric zone where only one species is present. The data shows that the range of beak sizes for Species A in the allopatric zone is similar to its range in the sympatric zone. However, the beak size of Species B in the sympatric zone is significantly larger and has a narrower range than its beak size in the allopatric zone. Which of the following is the most likely conclusion about the interaction between these two species?",
        options: [
            "A. Species A is competitively superior to Species B, leading to the exclusion of smaller-beaked individuals of Species B in the sympatric zone.",
            "B. Interspecific competition for food resources is causing character displacement, and the shift in beak size is more pronounced in Species B.",
            "C. The difference in beak size is a result of reproductive character displacement, as larger beaks in Species B prevent interbreeding with Species A.",
            "D. The observed pattern is an example of competitive exclusion, where Species A is outcompeting Species B for resources, leading to the displacement of Species B's population."
        ],
        correctAnswer: "B. Interspecific competition for food resources is causing character displacement, and the shift in beak size is more pronounced in Species B."
    },
    {
        question: "A conservation biologist is trying to reintroduce a rare species of squirrel, Sciurus rarissimus, into a forest ecosystem. The biologist is considering two potential reintroduction sites. Site 1 has a coexisting population of Sciurus vulgaris, a very common squirrel species with a similar diet of nuts and seeds. Site 2 has a population of Glaucomys volans, a flying squirrel that primarily eats insects and fungi. Based on the principle of character displacement, which of the following is the most effective long-term strategy for the successful reintroduction of S. rarissimus?",
        options: [
            "A. Introduce S. rarissimus into Site 1 because competition with S. vulgaris will lead to character displacement, reducing niche overlap and ensuring the long-term survival of both species.",
            "B. Introduce S. rarissimus into Site 2 because the lack of competition with G. volans for primary food resources will increase the likelihood of the new population establishing itself.",
            "C. Introduce a small number of S. rarissimus into both sites to test which site is more suitable, as the outcome of character displacement is unpredictable.",
            "D. Introduce S. rarissimus into Site 1 and provide supplemental food resources to S. vulgaris to temporarily reduce competition and allow the new population to grow."
        ],
        correctAnswer: "B. Introduce S. rarissimus into Site 2 because the lack of competition with G. volans for primary food resources will increase the likelihood of the new population establishing itself."
    },
    {
        question: "An ornithologist observes two species of warblers, Dendroica A and Dendroica B, living in a forest. Both species forage for insects on tree trunks and branches. Where their territories overlap, Dendroica A forages primarily on the lower parts of tree trunks, while Dendroica B forages on the upper canopy branches. In areas where Dendroica A is absent, Dendroica B is found foraging across the entire range of the tree, from the trunk to the canopy. The ornithologist hypothesizes that character displacement in foraging behavior has occurred. Which of the following interventions would provide the strongest evidence to support this hypothesis?",
        options: [
            "A. Temporarily remove Dendroica A from a sympatric area and observe if Dendroica B expands its foraging range to include the lower tree trunks.",
            "B. Genetically sequence both species in allopatric and sympatric zones to identify genes responsible for foraging behavior differences.",
            "C. Analyze stomach contents of both species in sympatric and allopatric zones to see if their diets are more different in the sympatric zone.",
            "D. Introduce a third insectivorous species, Parula C, that forages in the middle of the tree to see how both Dendroica species respond."
        ],
        correctAnswer: "A. Temporarily remove Dendroica A from a sympatric area and observe if Dendroica B expands its foraging range to include the lower tree trunks."
    },
    {
        question: "A research team is studying two species of honeybees, Species A and Species B, that coexist in the same forest. Species A, a larger bee, primarily forages for nectar on tall flowering trees. Species B, a smaller bee, forages on smaller flowering shrubs closer to the ground. When the researchers remove a significant portion of the tall flowering trees from the ecosystem, they observe that the population of Species A declines while the population of Species B remains stable. Which of the following is the most likely explanation for this observation?",
        options: [
            "A. The resource partitioning between the two species is based solely on the type of flower, not the height of the plant, and the removal of tall trees did not affect the flowers of the shrubs.",
            "B. The two species have successfully partitioned their resources based on foraging height, and the removal of the specific resource used by Species A led to its population decline.",
            "C. Species B has a broader fundamental niche than Species A, allowing it to adapt to the environmental change more easily.",
            "D. The competition between Species A and Species B for nectar has intensified, and Species A is less successful at competing for resources on the ground."
        ],
        correctAnswer: "B. The two species have successfully partitioned their resources based on foraging height, and the removal of the specific resource used by Species A led to its population decline."
    },
    {
        question: "In a tidal zone, three species of barnacles (Species X, Y, and Z) compete for space on rocks. Species X is found only in the upper tidal zone, Species Y is found in the middle zone, and Species Z is found in the lower zone. Lab experiments show that all three species can survive across all three zones when grown individually. What is the most likely reason for the observed distribution pattern?",
        options: [
            "A. Interspecific competition forces each species to occupy a smaller, realized niche within its fundamental niche.",
            "B. The differences in tolerance to desiccation and wave action are the primary drivers of the observed distribution.",
            "C. The species have evolved specialized physiological adaptations that restrict them to their specific zones, a form of competitive exclusion.",
            "D. The species have distinct fundamental niches, which prevents them from successfully colonizing other zones."
        ],
        correctAnswer: "A. Interspecific competition forces each species to occupy a smaller, realized niche within its fundamental niche."
    },
    {
        question: "A biologist observes five species of warblers coexisting in a single forest. They all feed on insects but do so in different ways and in different parts of the trees. Which of the following strategies is the most direct application of the principle of resource partitioning to explain this coexistence?",
        options: [
            "A. Observing the nesting habits and mating rituals of each warbler species to understand reproductive isolation.",
            "B. Analyzing the stomach contents of each warbler species and the specific locations on the trees where they forage.",
            "C. Measuring the total population size of each warbler species to determine which one is competitively dominant.",
            "D. Conducting a mark-recapture study to estimate the density of the insect prey available to the warblers."
        ],
        correctAnswer: "B. Analyzing the stomach contents of each warbler species and the specific locations on the trees where they forage."
    },
    {
        question: "A biologist is studying two species of bacteria, Species A and Species B, that both consume glucose. In a laboratory setting, when each species is grown in isolation with an ample supply of glucose, both populations grow exponentially and reach a high carrying capacity. However, when both species are grown together in the same culture, the population of Species A quickly outcompetes Species B, leading to the extinction of Species B. What is the most likely reason for this outcome?",
        options: [
            "A. The competitive exclusion principle is at play, as the two species have an identical ecological niche.",
            "B. Species A and Species B have different fundamental niches, preventing them from coexisting.",
            "C. The presence of both species creates a new environmental condition that is toxic to Species B.",
            "D. The resource partitioning between the two species is based on their growth rates, leading to the exclusion of the slower-growing species."
        ],
        correctAnswer: "A. The competitive exclusion principle is at play, as the two species have an identical ecological niche."
    },
    {
        question: "Two species of protists, Paramecium aurelia and Paramecium caudatum, are grown separately and together in a nutrient broth. When grown alone, both species exhibit logistic growth. When grown together, P. aurelia outcompetes P. caudatum, leading to the decline and eventual extinction of the latter. Which of the following graphs best represents the population dynamics of P. caudatum when grown with P. aurelia?",
        options: [
            "A. A graph showing an initial increase in P. caudatum's population, followed by a sharp decline and eventual stabilization at a low, non-zero number.",
            "B. A graph showing an initial increase in P. caudatum's population, followed by a gradual decline until its population reaches zero.",
            "C. A graph showing a stable, non-zero population for P. caudatum from the beginning of the experiment.",
            "D. A graph showing exponential growth of P. caudatum's population that then plateaus at its carrying capacity."
        ],
        correctAnswer: "B. A graph showing an initial increase in P. caudatum's population, followed by a gradual decline until its population reaches zero."
    },
    {
        question: "A conservation manager is tasked with reintroducing native prairie dogs, Cynomys ludovicianus, to a grassland ecosystem that has a stable population of non-native ground squirrels, Spermophilus tridecemlineatus. Both species have a similar diet of grasses and seeds. To apply the principle of resource partitioning to increase the chances of the prairie dog population establishing successfully, which of the following strategies should the manager use?",
        options: [
            "A. Introduce a predator, such as a coyote, to control both the prairie dog and ground squirrel populations.",
            "B. Eliminate the ground squirrel population entirely before reintroducing the prairie dogs.",
            "C. Provide supplemental food (e.g., hay and seeds) for the prairie dog population after they are introduced.",
            "D. Introduce the prairie dogs into a different, resource-rich part of the grassland where ground squirrels are less common."
        ],
        correctAnswer: "D. Introduce the prairie dogs into a different, resource-rich part of the grassland where ground squirrels are less common."
    },
    {
        question: "A researcher observes two species of woodpeckers, Species A and Species B, that both feed on insects found in tree bark. Species A forages exclusively on oak trees, while Species B forages on both oak and maple trees. When the oak trees in a forest are removed due to a disease, the researcher observes that the population of Species B declines significantly. What is the most plausible explanation for this decline, based on the competitive exclusion principle?",
        options: [
            "A. The two species occupied identical niches, and the removal of the oak trees caused the extinction of Species A, which then allowed Species B to thrive and increase its population.",
            "B. The removal of oak trees intensified competition between the two species, leading to the competitive exclusion of Species B.",
            "C. The removal of oak trees eliminated the competitive pressure from Species A on Species B, but Species B's dependence on oaks for a part of its niche led to its population decline.",
            "D. The two species were already practicing resource partitioning by tree type, and the removal of a shared resource niche negatively impacted both populations, but especially Species B."
        ],
        correctAnswer: "C. The removal of oak trees eliminated the competitive pressure from Species A on Species B, but Species B's dependence on oaks for a part of its niche led to its population decline."
    },
    {
        question: "A researcher is studying a species of warbler, Dendroica varia, that forages for insects on tree trunks and large branches. In a forest where Dendroica varia is the only warbler species, it is observed to forage from the base of the trees all the way to the crown. However, in a different forest where it coexists with a second, more competitively dominant warbler species, Dendroica coronata, Dendroica varia is only observed to forage on the lower parts of the tree trunks and branches. Based on this observation, what is the most accurate conclusion about the niches of Dendroica varia?",
        options: [
            "A. The realized niche of Dendroica varia is the entire tree, and its fundamental niche is the lower parts of the tree.",
            "B. In the first forest, the warbler's realized niche is the entire tree, which is a perfect representation of its fundamental niche.",
            "C. The fundamental niche of Dendroica varia includes the entire tree, while its realized niche in the second forest is restricted to the lower parts of the tree.",
            "D. The coexistence of the two species is an example of competitive exclusion, which implies that their fundamental niches are identical."
        ],
        correctAnswer: "C. The fundamental niche of Dendroica varia includes the entire tree, while its realized niche in the second forest is restricted to the lower parts of the tree."
    },
    {
        question: "An ecologist is studying the foraging behavior of a single species of fish, Species X, in two different streams. Stream 1 is a remote, pristine environment with no other fish species. Stream 2 is a polluted environment with a large population of a different, more aggressive fish species, Species Y. The ecologist finds that Species X in Stream 1 consumes a wide variety of aquatic insects and larvae, while in Stream 2, it exclusively consumes insects from the surface of the water and avoids the deeper parts of the stream where Species Y is concentrated. Based on this information, which of the following is the most accurate analysis?",
        options: [
            "A. The abiotic factors of Stream 2 (e.g., pollution) are forcing Species X to occupy a smaller fundamental niche.",
            "B. The niche occupied by Species X in Stream 1 is its fundamental niche, while its niche in Stream 2 is its realized niche, a result of competition.",
            "C. The fundamental niche of Species X is limited to surface insects in both streams, and its behavior in Stream 1 is an anomaly.",
            "D. The presence of pollution in Stream 2 caused a change in the fundamental niche of Species X, making it a surface feeder."
        ],
        correctAnswer: "B. The niche occupied by Species X in Stream 1 is its fundamental niche, while its niche in Stream 2 is its realized niche, a result of competition."
    },
    {
        question: "A species of spider, Arachnida a, is a generalist predator that can build webs and hunt on the ground. When a new, more efficient web-building spider, Arachnida b, is introduced into its habitat, researchers observe a significant decline in the population of Arachnida a. After several years, Arachnida a is found to have survived, but its population is now concentrated in areas with less vegetation, where it primarily hunts on the ground. What is the most accurate ecological explanation for the long-term survival of Arachnida a?",
        options: [
            "A. The fundamental niche of Arachnida a has been reduced due to competition, making it a ground-hunting specialist.",
            "B. The competitive exclusion principle did not apply, as the two species have distinct fundamental niches.",
            "C. The realized niche of Arachnida a was able to shift to a new part of its fundamental niche, allowing for coexistence through resource partitioning.",
            "D. Arachnida b is a less effective competitor, and its population is declining, allowing Arachnida a to recover its original niche."
        ],
        correctAnswer: "C. The realized niche of Arachnida a was able to shift to a new part of its fundamental niche, allowing for coexistence through resource partitioning."
    },
    {
        question: "A team of ecologists is studying a species of fish that lives in a coastal estuary. When they are the only fish species present, they forage on a wide variety of prey, including small crustaceans and bottom-dwelling invertebrates. However, in the presence of a larger, competitively dominant fish species, their diet is restricted to only the small crustaceans. In this scenario, what is the most accurate description of the change in the smaller fish's niche?",
        options: [
            "A. The fundamental niche of the smaller fish has changed from a generalist to a specialist.",
            "B. The trophic niche of the smaller fish has been reduced by competitive exclusion.",
            "C. The habitat niche of the smaller fish has been reduced, forcing a change in its diet.",
            "D. The hypervolume niche of the smaller fish has been expanded by the presence of a competitor."
        ],
        correctAnswer: "B. The trophic niche of the smaller fish has been reduced by competitive exclusion."
    },
    {
        question: "Two species of tropical insects, Insect A and Insect B, both feed on the sap of a single species of tree. Insect A is found primarily on the upper branches of the tree, while Insect B is found on the lower trunk and roots. When a novel tree disease begins to kill off the lower parts of the tree, the population of Insect B declines. However, researchers observe that the population of Insect A also begins to decline over time, even though the upper branches are not yet affected by the disease. What is the most likely explanation for the decline of Insect A?",
        options: [
            "A. The fundamental niche of Insect A has been reduced by a change in a single environmental dimension.",
            "B. The trophic niche of Insect A is being indirectly affected by the decline of Insect B, a shared food source.",
            "C. The hypervolume niche of Insect A is a two-dimensional space where a change in one dimension (resource availability) affects another (competition).",
            "D. A reduction in the habitat niche of Insect B is leading to an expansion of the habitat niche for Insect A, increasing competition."
        ],
        correctAnswer: "C. The hypervolume niche of Insect A is a two-dimensional space where a change in one dimension (resource availability) affects another (competition)."
    },
    {
        question: "A species of frog is observed to be active and hunt for insects both on land and in the water during the day. However, a researcher notices that when a predatory snake, which hunts primarily on land during the day, enters the ecosystem, the frog population shifts its activity to hunting in the water and becomes more active at night. Which of the following best describes the change in the frog's niche?",
        options: [
            "A. The frog's habitat niche has changed, but its trophic niche remains the same.",
            "B. The frog's trophic niche has changed, but its habitat niche remains the same.",
            "C. The fundamental niches of both the frog and the snake have been reduced.",
            "D. The realized habitat niche of the frog has shifted to a different temporal and spatial dimension."
        ],
        correctAnswer: "D. The realized habitat niche of the frog has shifted to a different temporal and spatial dimension."
    },
    {
        question: "The African honey bee (Apis mellifera scutellata) is an aggressive invasive species in the Americas. It is known to build nests in a wide variety of locations, from hollow trees to abandoned buildings. Its diet is also very broad, as it forages on nectar and pollen from numerous plant species. The success of this invasive species is best explained by which niche concept?",
        options: [
            "A. The species has a very narrow trophic niche, allowing it to specialize on a single resource.",
            "B. The species has a very large fundamental niche, allowing it to occupy a wide variety of habitats and use many food sources.",
            "C. The species' realized habitat niche is smaller than its fundamental niche due to competitive pressure.",
            "D. The species has a very specific hypervolume niche, which makes it an effective competitor."
        ],
        correctAnswer: "B. The species has a very large fundamental niche, allowing it to occupy a wide variety of habitats and use many food sources."
    },
    {
        question: "A scientist is studying two species of snails, Species A and Species B, in an aquarium. When grown alone, both species can tolerate water temperatures from 15C to 30C and a wide range of salinity from 10 ppt to 35 ppt. However, when grown together, Species A is only found in temperatures between 15C and 22C, while Species B occupies the higher temperature range. Both species still tolerate the full range of salinity. How would a researcher describe the change in the hypervolume niche of Species A?",
        options: [
            "A. The realized trophic niche of Species A is now restricted to a narrower temperature range.",
            "B. The fundamental niche of Species A has been reduced along the temperature axis.",
            "C. The realized hypervolume niche of Species A is a smaller volume due to a reduction in the temperature dimension caused by competition.",
            "D. The realized habitat niche of Species A has expanded to include a wider range of temperatures."
        ],
        correctAnswer: "C. The realized hypervolume niche of Species A is a smaller volume due to a reduction in the temperature dimension caused by competition."
    },
    {
        question: "The term \"habitat\" refers to an organism's physical location, while \"niche\" describes its ecological role. Which of the following is the best analogy for this relationship?",
        options: [
            "A. Habitat is like a person's name, and niche is like their personality.",
            "B. Habitat is like a person's job, and niche is like their home address.",
            "C. Habitat is like a person's home address, and niche is like their job or profession.",
            "D. Habitat is like a person's life history, and niche is like their environment."
        ],
        correctAnswer: "C. Habitat is like a person's home address, and niche is like their job or profession."
    },
    {
        question: "Which of the following statements accurately distinguishes a fundamental niche from a realized niche?",
        options: [
            "A. A fundamental niche includes all biotic factors, while a realized niche includes all abiotic factors.",
            "B. A fundamental niche is smaller than a realized niche because it is limited by competition.",
            "C. A fundamental niche is the full range of resources and conditions a species could use, while a realized niche is what it actually uses.",
            "D. A fundamental niche is specific to one species, while a realized niche is shared by multiple species."
        ],
        correctAnswer: "C. A fundamental niche is the full range of resources and conditions a species could use, while a realized niche is what it actually uses."
    },
    {
        question: "According to the competitive exclusion principle, two species cannot coexist if they:",
        options: [
            "A. Inhabit the same geographical area.",
            "B. Occupy the same ecological niche.",
            "C. Have a parasitic relationship.",
            "D. Belong to the same taxonomic family."
        ],
        correctAnswer: "B. Occupy the same ecological niche."
    },
    {
        question: "Resource partitioning is a mechanism that allows two or more species to coexist by:",
        options: [
            "A. Competing for the same limiting resources until one is eliminated.",
            "B. Sharing a single limiting resource equally among all individuals.",
            "C. Evolving to use different parts of a shared resource or use it at different times.",
            "D. Increasing the population size of their shared predators."
        ],
        correctAnswer: "C. Evolving to use different parts of a shared resource or use it at different times."
    },
    {
        question: "The long-term coexistence of two competing species with significant niche overlap is most likely to occur if:",
        options: [
            "A. Their fundamental niches are identical.",
            "B. The competitive exclusion principle is actively enforced.",
            "C. The species are able to partition their shared resources.",
            "D. The population of one species is consistently larger than the other."
        ],
        correctAnswer: "C. The species are able to partition their shared resources."
    },
    {
        question: "Which of the following best defines an organism's trophic niche?",
        options: [
            "A. The physical location where it lives and reproduces.",
            "B. Its position in the food web, including what it eats and what eats it.",
            "C. The range of temperatures it can tolerate.",
            "D. Its ability to coexist with competing species."
        ],
        correctAnswer: "B. Its position in the food web, including what it eats and what eats it."
    },
    {
        question: "A species' habitat niche is primarily defined by which of the following?",
        options: [
            "A. The types of food it consumes.",
            "B. The number of predators it has.",
            "C. The physical and temporal space it occupies.",
            "D. The total number of resources it utilizes."
        ],
        correctAnswer: "C. The physical and temporal space it occupies."
    },
    {
        question: "The concept of a hypervolume niche is best described as:",
        options: [
            "A. A three-dimensional space that defines a species' habitat.",
            "B. A single-dimensional representation of a species' trophic level.",
            "C. A multi-dimensional space where each dimension represents an environmental factor or resource.",
            "D. A measure of the total biomass of a species in a given area."
        ],
        correctAnswer: "C. A multi-dimensional space where each dimension represents an environmental factor or resource."
    },
    {
        question: "A species of barnacle can live anywhere in the intertidal zone, from the high-tide line to the low-tide line. However, due to competition from a different barnacle species, it is only found in the upper portion of the intertidal zone. This is an example of the species' realized niche being:",
        options: [
            "A. Larger than its fundamental niche.",
            "B. Smaller than its fundamental niche.",
            "C. Identical to its fundamental niche.",
            "D. Broader than its realized niche."
        ],
        correctAnswer: "B. Smaller than its fundamental niche."
    },
    {
        question: "In a laboratory experiment, two species of flour beetles, Tribolium confusum and Tribolium castaneum, are grown together in a container with a limited amount of flour. Within a few months, only T. castaneum remains. This outcome is a classic example of:",
        options: [
            "A. Resource partitioning.",
            "B. Character displacement.",
            "C. Competitive exclusion.",
            "D. Species coexistence."
        ],
        correctAnswer: "C. Competitive exclusion."
    },
    {
        question: "Two species of lizards, both insectivores, coexist in a forest. One species hunts for insects on the ground, while the other species hunts for insects on tree branches. This is an example of coexistence made possible by:",
        options: [
            "A. Competitive exclusion.",
            "B. A reduction in their fundamental niches.",
            "C. Geographic isolation.",
            "D. Resource partitioning by habitat."
        ],
        correctAnswer: "D. Resource partitioning by habitat."
    },
    {
        question: "A species of bird, which normally forages for insects on the ground, is forced to forage on tree trunks after an invasive, more efficient ground-foraging bird is introduced to the ecosystem. This change represents a shift in the bird's (A), causing a change in a dimension of its (B), which allows for (C) between the two species.",
        options: [
            "A. (A) Trophic niche; (B) hypervolume niche; (C) competitive exclusion.",
            "B. (A) Realized niche; (B) habitat niche; (C) resource partitioning.",
            "C. (A) Fundamental niche; (B) habitat niche; (C) competitive exclusion.",
            "D. (A) Trophic niche; (B) realized niche; (C) species coexistence."
        ],
        correctAnswer: "B. (A) Realized niche; (B) habitat niche; (C) resource partitioning."
            }
        ];

        // --- Quiz Configuration ---
        const questionMarks = 2;
        const negativeMarkingValue = 0.5;
        const quizDuration = 25 * 60;
        const currentQuizVersion = "Niche_Habitat_v2.0"; // Updated quiz version

        // --- HTML Element References ---
        const loginPage = document.getElementById('login-page');
        const studentNameInput = document.getElementById('student-name-input');
        const startQuizButton = document.getElementById('start-quiz-button');

        const noticePage = document.getElementById('notice-page');
        const continueQuizButton = document.getElementById('continue-quiz-button');

        const quizPage = document.getElementById('quiz-page');
        const timerDisplay = document.getElementById('timer-display');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const saveNextButton = document.getElementById('save-next-button');
        const clearButton = document.getElementById('clear-button');
        const nextButton = document.getElementById('next-button');
        const quizNavButtons = document.querySelector('.quiz-nav-buttons');
        const questionPalette = document.getElementById('question-palette');
        const quizSidebar = document.getElementById('quiz-sidebar');

        const finalResultsPage = document.getElementById('final-results-page');
        const studentNameDisplay = document.getElementById('student-name-display');
        const attemptedDisplay = document.getElementById('attempted-display');
        const correctDisplay = document.getElementById('correct-display');
        const incorrectDisplay = document.getElementById('incorrect-display');
        const finalScoreDisplay = document.getElementById('final-score-display');
        const maxMarksDisplay = document.getElementById('max-marks-display');
        const showAnswerKeyButton = document.getElementById('show-answer-key-button');

        const adminPasscodeInput = document.getElementById('admin-passcode-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLoginMessage = document.getElementById('admin-login-message');

        const adminResultsModal = document.getElementById('admin-results-modal');
        const adminResultsDisplayArea = document.getElementById('admin-results-display-area');
        const closeAdminModalButton = document.getElementById('close-admin-modal');

        const appFooter = document.getElementById('app-footer');

        // New Answer Key Navigation Buttons
        const answerKeyNavButtons = document.querySelector('.answer-key-nav-buttons');
        const prevAnswerKeyButton = document.getElementById('prev-answer-key-button');
        const nextAnswerKeyButton = document.getElementById('next-answer-key-button');


        // --- Quiz State Variables ---
        let studentName = '';
        let currentQuestionIndex = 0;
        // 0: Not visited, 1: Visited but not answered (red), 2: Answered (green)
        let questionStatus = Array(quizData.length).fill(0);
        let savedAnswers = Array(quizData.length).fill(null);
        let timeLeft = quizDuration;
        let timerInterval;
        let quizSubmitted = false;
        let isAnswerKeyMode = false;

        window.selectedAnswer = null;

        // --- Integrity Check ---
        const expectedFooterText = "betabiosciences@gmail.com";
        function checkFooterIntegrity() {
            if (appFooter && appFooter.textContent !== expectedFooterText) {
                console.error("Integrity check failed: Footer text modified!");
                clearInterval(timerInterval);
                [startQuizButton, continueQuizButton, saveNextButton, clearButton, nextButton, adminLoginButton, showAnswerKeyButton, prevAnswerKeyButton, nextAnswerKeyButton].forEach(btn => {
                    if (btn) btn.disabled = true;
                });
                const body = document.querySelector('body');
                const alertDiv = document.createElement('div');
                alertDiv.style.position = 'fixed';
                alertDiv.style.top = '20px';
                alertDiv.style.left = '50%';
                alertDiv.style.transform = 'translateX(-50%)';
                alertDiv.style.backgroundColor = 'red';
                alertDiv.style.color = 'white';
                alertDiv.style.padding = '15px';
                alertDiv.style.borderRadius = '8px';
                alertDiv.style.zIndex = '2000';
                alertDiv.textContent = "Quiz functionality has been disabled due to an integrity check failure. Please do not modify the footer text.";
                body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
                return false;
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkFooterIntegrity, 100);
        });


        // --- Page Navigation Functions ---
        function showPage(pageElement) {
            [loginPage, noticePage, quizPage, finalResultsPage].forEach(page => {
                if (page) page.classList.add('hidden');
            });
            if (pageElement) pageElement.classList.remove('hidden');
        }

        function showModal(modalElement) {
            if (modalElement) modalElement.classList.remove('hidden');
        }

        function hideModal(modalElement) {
            if (modalElement) modalElement.classList.add('hidden');
        }


        // --- Login Page Logic ---
        studentNameInput.addEventListener('input', () => {
            startQuizButton.disabled = studentNameInput.value.trim() === '';
        });

        startQuizButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            studentName = studentNameInput.value.trim();
            if (studentName) {
                showPage(noticePage);
            }
        });

        // --- Notice Page Logic ---
        continueQuizButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            showPage(quizPage);
            startTimer();
            loadQuestion(currentQuestionIndex);
            renderQuestionPalette();
            quizNavButtons.classList.remove('hidden');
            answerKeyNavButtons.classList.add('hidden');
            timerDisplay.classList.remove('hidden');
            quizSidebar.classList.remove('hidden');
        });

        // --- Timer Logic ---
        function startTimer() {
            timerInterval = setInterval(() => {
                if (!checkFooterIntegrity()) {
                    clearInterval(timerInterval);
                    return;
                }
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuizAutomatically();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timerDisplay.classList.remove('orange', 'red', 'green');
            if (timeLeft <= 60) {
                timerDisplay.classList.add('red');
            } else if (timeLeft <= 180) {
                timerDisplay.classList.add('orange');
            } else {
                timerDisplay.classList.add('green');
            }
        }

        function submitQuizAutomatically() {
            if (!quizSubmitted) {
                const body = document.querySelector('body');
                const alertDiv = document.createElement('div');
                alertDiv.style.position = 'fixed';
                alertDiv.style.top = '20px';
                alertDiv.style.left = '50%';
                alertDiv.style.transform = 'translateX(-50%)';
                alertDiv.style.backgroundColor = '#f59e0b';
                alertDiv.style.color = 'white';
                alertDiv.style.padding = '15px';
                alertDiv.style.borderRadius = '8px';
                alertDiv.style.zIndex = '2000';
                alertDiv.textContent = "Time's up! Your quiz has been automatically submitted.";
                body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
                submitQuiz();
            }
        }

        // --- Quiz Page Logic ---
        function loadQuestion(index) {
            if (!checkFooterIntegrity()) return;
            currentQuestionIndex = index;
            optionsContainer.innerHTML = '';
            window.selectedAnswer = savedAnswers[currentQuestionIndex]; // Load previously selected answer

            const currentQuestion = quizData[currentQuestionIndex];
            questionText.textContent = `Q${index + 1}: ${currentQuestion.question}`;

            questionImage.classList.add('hidden');
            questionImage.src = '';


            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');

                if (isAnswerKeyMode) {
                    const cleanedOption = option.replace(/^[A-D]\)\s*/, '');
                    const cleanedCorrectAnswer = currentQuestion.correctAnswer.replace(/^[A-D]\)\s*/, '');
                    const cleanedStudentAnswer = savedAnswers[currentQuestionIndex] ? savedAnswers[currentQuestionIndex].replace(/^[A-D]\)\s*/, '') : null;

                    if (cleanedOption === cleanedCorrectAnswer) {
                        button.classList.add('correct-answer');
                    }
                    if (cleanedStudentAnswer === cleanedOption && cleanedOption !== cleanedCorrectAnswer) {
                        button.classList.add('incorrect-answer');
                    }
                    button.classList.add('disabled-for-answer-key');
                } else {
                    if (savedAnswers[currentQuestionIndex] === option) {
                        button.classList.add('selected');
                    }
                    button.addEventListener('click', () => selectAnswer(button, option));
                }
                optionsContainer.appendChild(button);
            });

            if (!isAnswerKeyMode) {
                // IMPORTANT FIX: Mark as visited (red) if not already answered
                if (questionStatus[currentQuestionIndex] === 0) {
                    questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                }
                updateQuestionPalette();

                if (currentQuestionIndex === quizData.length - 1) {
                    nextButton.textContent = 'Submit Quiz';
                    nextButton.classList.add('submit-quiz');
                    nextButton.classList.remove('next');
                } else {
                    nextButton.textContent = 'Next';
                    nextButton.classList.remove('submit-quiz');
                    nextButton.classList.add('next');
                }
            } else {
                prevAnswerKeyButton.disabled = (currentQuestionIndex === 0);
                nextAnswerKeyButton.classList.add('answer-key-nav-button');
                if (currentQuestionIndex === quizData.length - 1) {
                    nextAnswerKeyButton.textContent = 'Close Answer Key';
                    nextAnswerKeyButton.classList.add('close-answer-key');
                } else {
                    nextAnswerKeyButton.textContent = 'Next';
                    nextAnswerKeyButton.classList.remove('close-answer-key');
                }
            }
        }

        function selectAnswer(button, optionText) {
            if (!checkFooterIntegrity()) return;
            document.querySelectorAll('.option-button.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            window.selectedAnswer = optionText;
        }

        saveNextButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (window.selectedAnswer !== null) {
                savedAnswers[currentQuestionIndex] = window.selectedAnswer;
                questionStatus[currentQuestionIndex] = 2; // Mark as answered (green)
            } else {
                // If Save & Next is clicked without selecting an answer, it remains 'visited but unanswered' or 'not visited'
                // For 'Save & Next', we assume intent to save (even if null) and move on.
                // If it was already green (answered), it stays green. If red, it stays red. If grey, it becomes red.
                 if (questionStatus[currentQuestionIndex] === 0) { // If not visited
                     questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                 }
            }
            moveToNextQuestion();
        });

        clearButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            window.selectedAnswer = null;
            savedAnswers[currentQuestionIndex] = null;
            document.querySelectorAll('.option-button.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
            updateQuestionPalette();
        });

        nextButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;

            // If "Next" is clicked:
            // 1. If an answer is selected, mark as answered (green).
            // 2. If no answer is selected but the question was previously green (answered), it remains green.
            // 3. If no answer is selected and it was grey (not visited) or red (visited but not answered), it becomes red.
            if (window.selectedAnswer !== null) {
                 savedAnswers[currentQuestionIndex] = window.selectedAnswer;
                 questionStatus[currentQuestionIndex] = 2; // Mark as answered (green)
            } else {
                 if (questionStatus[currentQuestionIndex] === 0 || questionStatus[currentQuestionIndex] === 1) {
                     questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                 }
            }

            if (currentQuestionIndex === quizData.length - 1) {
                submitQuiz();
            } else {
                moveToNextQuestion();
            }
        });

        function moveToNextQuestion() {
            if (currentQuestionIndex < quizData.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                console.log("Already on the last question. Consider submitting.");
            }
        }

        function renderQuestionPalette() {
            questionPalette.innerHTML = '';
            quizData.forEach((_, index) => {
                const box = document.createElement('div');
                box.classList.add('palette-box');
                box.textContent = index + 1;
                box.addEventListener('click', () => loadQuestion(index));
                questionPalette.appendChild(box);
            });
            updateQuestionPalette();
        }

        function updateQuestionPalette() {
            const paletteBoxes = questionPalette.children;
            if (paletteBoxes.length !== quizData.length) {
                console.warn("Palette boxes count mismatch with quiz data. Re-rendering palette.");
                renderQuestionPalette();
                return;
            }
            questionStatus.forEach((status, index) => {
                const box = paletteBoxes[index];
                if (box) {
                    box.classList.remove('unanswered', 'answered', 'grey'); // Remove all states first
                    if (status === 1) { // Visited but not answered (red)
                        box.classList.add('unanswered');
                    } else if (status === 2) { // Answered (green)
                        box.classList.add('answered');
                    } else { // Not visited (grey)
                        box.classList.add('grey');
                    }
                }
            });
        }

        // --- Final Submission and Results Logic ---
        async function submitQuiz() {
            if (!checkFooterIntegrity()) return;
            if (quizSubmitted) return;
            quizSubmitted = true;
            clearInterval(timerInterval);

            let correctAnswersCount = 0;
            let incorrectAnswersCount = 0;
            let attemptedQuestionsCount = 0;
            let finalScore = 0;

            quizData.forEach((question, index) => {
                const studentAnswer = savedAnswers[index];
                if (studentAnswer !== null) {
                    attemptedQuestionsCount++;
                    const cleanedStudentAnswer = studentAnswer.replace(/^[A-D]\)\s*/, '');
                    const cleanedCorrectAnswer = question.correctAnswer.replace(/^[A-D]\)\s*/, '');

                    if (cleanedStudentAnswer === cleanedCorrectAnswer) {
                        correctAnswersCount++;
                        finalScore += questionMarks;
                    } else {
                        incorrectAnswersCount++;
                        finalScore -= negativeMarkingValue;
                    }
                }
            });

            studentNameDisplay.textContent = studentName;
            attemptedDisplay.textContent = attemptedQuestionsCount;
            correctDisplay.textContent = correctAnswersCount;
            incorrectDisplay.textContent = incorrectAnswersCount;
            finalScoreDisplay.textContent = finalScore.toFixed(1);

            const maxPossibleMarks = quizData.length * questionMarks;
            maxMarksDisplay.textContent = maxPossibleMarks;

            showPage(finalResultsPage);

            if (isAuthReady && db && userId) {
                try {
                    const resultsCollectionRef = collection(db, `quizzes/${projectIdForFirestorePath}/results`);
                    const submissionId = `${userId}_${Date.now()}`;
                    await setDoc(doc(resultsCollectionRef, submissionId), {
                        studentName: studentName,
                        score: parseFloat(finalScore.toFixed(1)),
                        attemptedQuestions: attemptedQuestionsCount,
                        correctAnswers: correctAnswersCount,
                        incorrectAnswers: incorrectAnswersCount,
                        maxMarks: maxPossibleMarks,
                        timestamp: serverTimestamp(),
                        userId: userId,
                        quizVersion: currentQuizVersion
                    });
                    console.log("Quiz results saved to Firestore!");
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                    const resultsPage = document.getElementById('final-results-page');
                    let saveErrorMsg = document.getElementById('saveErrorMsg');
                    if (!saveErrorMsg) {
                        saveErrorMsg = document.createElement('p');
                        saveErrorMsg.id = 'saveErrorMsg';
                        saveErrorMsg.style.color = 'red';
                        saveErrorMsg.style.marginTop = '10px';
                        resultsPage.insertBefore(saveErrorMsg, document.querySelector('.telegram-link'));
                    }
                    saveErrorMsg.textContent = "Note: Could not save results to the server. Please ensure you are connected to the internet.";
                }
            } else {
                console.warn("Firestore not ready or user not authenticated. Results not saved.");
                const resultsPage = document.getElementById('final-results-page');
                let saveErrorMsg = document.getElementById('saveErrorMsg');
                if (!saveErrorMsg) {
                    saveErrorMsg = document.createElement('p');
                    saveErrorMsg.id = 'saveErrorMsg';
                    saveErrorMsg.style.color = 'red';
                    saveErrorMsg.style.marginTop = '10px';
                    resultsPage.insertBefore(saveErrorMsg, document.querySelector('.telegram-link'));
                }
                saveErrorMsg.textContent = "Note: Could not save results to the server. Please ensure you are connected to the internet.";
            }
        }

        // --- Answer Key Logic ---
        showAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            isAnswerKeyMode = true;
            currentQuestionIndex = 0;
            showPage(quizPage);
            loadQuestion(currentQuestionIndex);

            timerDisplay.classList.add('hidden');
            quizNavButtons.classList.add('hidden');
            quizSidebar.classList.add('hidden');

            answerKeyNavButtons.classList.remove('hidden');
        });

        prevAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        });

        nextAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (currentQuestionIndex < quizData.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                closeAnswerKey();
            }
        });

        function closeAnswerKey() {
            isAnswerKeyMode = false;
            showPage(finalResultsPage);
            answerKeyNavButtons.classList.add('hidden');
            timerDisplay.classList.add('hidden');
            quizNavButtons.classList.add('hidden');
            quizSidebar.classList.add('hidden');
        }


        // --- Admin Login Logic (Scrambled Passcode) ---
        const obfuscatedPasscodeBytes = [106, 123, 114, 124, 75, 64, 63, 64, 65];
        const baseOffset = 7;

        function getAdminPasscode() {
            let decryptedPasscode = '';
            for (let i = 0; i < obfuscatedPasscodeBytes.length; i++) {
                decryptedPasscode += String.fromCharCode(obfuscatedPasscodeBytes[i] - baseOffset - i);
            }
            return decryptedPasscode;
        }

        adminLoginButton.addEventListener('click', async () => {
            if (!checkFooterIntegrity()) return;
            const enteredPasscode = adminPasscodeInput.value;
            adminLoginMessage.classList.add('hidden');

            if (enteredPasscode === getAdminPasscode()) {
                adminLoginMessage.textContent = "Loading admin results...";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#22c55e';

                await fetchAllQuizResults();
                adminResultsModal.classList.remove('hidden');
                adminLoginMessage.classList.add('hidden');
            } else {
                adminLoginMessage.textContent = "Incorrect passcode.";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#ef4444';
            }
        });

        closeAdminModalButton.addEventListener('click', () => {
            adminResultsModal.classList.add('hidden');
        });

        // --- Fetch and Display All Results for Admin Modal ---
        async function fetchAllQuizResults() {
            adminResultsDisplayArea.innerHTML = '<p class="loading-message">Loading results...</p>';
            if (!isAuthReady || !db) {
                adminResultsDisplayArea.innerHTML = '<p class="error-message">Firebase not ready. Please check configuration and authentication.</p>';
                console.warn("Firestore not ready for admin results fetch.");
                return;
            }

            try {
                const resultsCollectionRef = collection(db, `quizzes/${projectIdForFirestorePath}/results`);
                const q = query(resultsCollectionRef, where("quizVersion", "==", currentQuizVersion));
                const querySnapshot = await getDocs(q);
                const allResults = [];
                querySnapshot.forEach((doc) => {
                    allResults.push({ id: doc.id, ...doc.data() });
                });

                allResults.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                displayAdminResults(allResults);
            } catch (e) {
                console.error("Error fetching all quiz results: ", e);
                adminResultsDisplayArea.innerHTML = `<p class="error-message">Error fetching results: ${e.message}. Check console for details.</p>`;
            }
        }

        function displayAdminResults(results) {
            if (results.length === 0) {
                adminResultsDisplayArea.innerHTML = '<p class="no-results-message">No quiz results found yet.</p>';
                return;
            }

            let tableHtml = `
                <div class="admin-results-table-wrapper">
                    <table class="admin-results-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Score</th>
                                <th>Max Marks</th>
                                <th>Attempted</th>
                                <th>Correct</th>
                                <th>Incorrect</th>
                                <th>Date</th>
                                <th>User ID</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach(result => {
                const date = result.timestamp ? new Date(result.timestamp.toDate()).toLocaleString() : 'N/A';
                tableHtml += `
                    <tr>
                        <td>${result.studentName || 'N/A'}</td>
                        <td>${result.score !== undefined ? result.score.toFixed(1) : 'N/A'}</td>
                        <td>${result.maxMarks !== undefined ? result.maxMarks : (quizData.length * questionMarks)}</td>
                        <td>${result.attemptedQuestions !== undefined ? result.attemptedQuestions : 'N/A'}</td>
                        <td>${result.correctAnswers !== undefined ? result.correctAnswers : 'N/A'}</td>
                        <td>${result.incorrectAnswers !== undefined ? result.incorrectAnswers : 'N/A'}</td>
                        <td>${date}</td>
                        <td>${result.userId || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            adminResultsDisplayArea.innerHTML = tableHtml;
        }

        // Initial page load
        document.addEventListener('DOMContentLoaded', () => {
            showPage(loginPage);
        });
    </script>
</body>
</html>