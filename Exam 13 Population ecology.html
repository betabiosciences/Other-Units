<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetaBiosciences Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the quiz app */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
            color: #333;
        }

        .quiz-container {
            background-color: #ffffff; /* White background for the quiz card */
            border-radius: 16px; /* More rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 32px; /* Increased padding */
            max-width: 800px; /* Increased max width for more content */
            width: 100%; /* Full width on smaller screens */
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 24px; /* Space between sections */
            position: relative; /* For absolute positioning of footer */
        }

        .hidden {
            display: none !important; /* Use !important to override other display properties */
        }

        /* Login and Notice Page Styles */
        .page-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px; /* Ensure pages have some height */
        }

        .input-field {
            padding: 12px 16px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1.1rem;
            width: 80%;
            max-width: 300px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #6366f1;
        }

        .action-button {
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            color: #ffffff;
            background-color: #4f46e5; /* Indigo */
        }

        .action-button:hover:not(:disabled) {
            background-color: #4338ca; /* Darker indigo */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .action-button:disabled {
            background-color: #9ca3af; /* Gray for disabled */
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Notice Page Specifics */
        .notice-title {
            font-size: 2rem;
            font-weight: 800;
            color: #ef4444; /* Red for important */
            margin-bottom: 20px;
        }

        .notice-list {
            list-style: none; /* Removed default numbering/bullets */
            padding: 0;
            margin: 0 0 30px 0;
            text-align: left;
            width: 100%;
            max-width: 450px;
        }

        .notice-list li {
            font-size: 1.1rem;
            margin-bottom: 10px;
            line-height: 1.5;
            position: relative; /* For custom bullets */
            padding-left: 20px; /* Space for custom bullet */
        }

        .notice-list li::before {
            content: "\2022"; /* Unicode for a bullet point */
            color: #ef4444; /* Red bullet */
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
            position: absolute;
            left: 0;
            top: 0;
        }


        .notice-list strong {
            color: #ef4444; /* Red for bold parts */
        }

        /* Quiz Page Layout */
        #quiz-page {
            display: grid;
            grid-template-columns: 1fr 200px; /* Main content and sidebar */
            gap: 30px;
            text-align: left;
            min-height: 400px; /* Ensure sufficient height for the grid layout */
        }

        #quiz-main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #quiz-sidebar {
            background-color: #f8fafc; /* Lightest gray for sidebar */
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Timer Styles */
        #timer-display {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #22c55e; /* Green */
            text-align: center;
            width: 100%;
            grid-column: 1 / -1; /* Span across both columns */
        }

        #timer-display.orange {
            color: #f97316; /* Orange */
        }

        #timer-display.red {
            color: #ef4444; /* Red */
        }

        .question-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            text-align: left; /* Align question text left */
        }

        .question-image {
            max-width: 100%;
            height: auto;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: block;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .option-button {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 500;
            border: 2px solid transparent;
            text-align: left; /* Align options left */
        }

        .option-button:hover {
            background-color: #cbd5e0;
        }

        .option-button.selected {
            background-color: #6366f1;
            color: #ffffff;
            border-color: #4f46e5;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        /* New styles for answer key options */
        .option-button.correct-answer {
            background-color: #22c55e; /* Green */
            color: #ffffff;
            border-color: #16a34a;
            pointer-events: none; /* Disable clicks */
        }

        .option-button.incorrect-answer {
            background-color: #ef4444; /* Red */
            color: #ffffff;
            border-color: #dc2626;
            pointer-events: none; /* Disable clicks */
        }

        .option-button.disabled-for-answer-key {
            pointer-events: none; /* Disable clicks */
            opacity: 0.7; /* Slightly dim non-highlighted options */
        }


        .quiz-nav-buttons {
            display: flex;
            justify-content: flex-start; /* Align buttons to the left */
            gap: 12px;
            margin-top: 20px;
        }

        .quiz-nav-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .quiz-nav-button.save-next {
            background-color: #10b981; /* Green */
            color: #ffffff;
        }
        .quiz-nav-button.save-next:hover { background-color: #059669; }

        .quiz-nav-button.clear {
            background-color: #f59e0b; /* Amber */
            color: #ffffff;
        }
        .quiz-nav-button.clear:hover { background-color: #d97706; }

        .quiz-nav-button.next {
            background-color: #3b82f6; /* Blue */
            color: #ffffff;
        }
        .quiz-nav-button.next:hover { background-color: #2563eb; }

        .quiz-nav-button.submit-quiz {
            background-color: #ef4444; /* Red */
            color: #ffffff;
        }
        .quiz-nav-button.submit-quiz:hover { background-color: #dc2626; }

        /* Answer Key Navigation Buttons */
        .answer-key-nav-buttons {
            display: flex;
            justify-content: space-between; /* Space out prev/next */
            gap: 12px;
            margin-top: 20px;
        }

        .answer-key-nav-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            background-color: #6366f1; /* Indigo */
            color: #ffffff;
        }
        .answer-key-nav-button:hover:not(:disabled) {
            background-color: #4f46e5;
        }
        .answer-key-nav-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Specific style for the "Close Answer Key" button */
        .answer-key-nav-button.close-answer-key {
            background-color: #ef4444; /* Red */
        }
        .answer-key-nav-button.close-answer-key:hover:not(:disabled) {
            background-color: #dc2626; /* Darker red */
        }


        /* Legend and Palette Styles */
        .legend-box {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: left;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .legend-color-box.red-ball {
            background-color: transparent; /* No background for 3D ball */
            color: #ef4444; /* Red for the icon */
            font-size: 1.2rem;
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-color-box.grey {
            background-color: #d1d5db; /* Grey */
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            border-radius: 5px;
            margin-right: 10px;
        }
        .legend-color-box.green {
            background-color: #22c55e; /* Green */
            width: 20px; /* Fixed width */
            height: 20px; /* Fixed height */
            border-radius: 5px;
            margin-right: 10px;
        }


        #question-palette {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
            margin-top: 15px;
        }

        .palette-box {
            background-color: #d1d5db; /* Grey (not visited) */
            color: #333;
            padding: 10px 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Make boxes square */
        }

        .palette-box:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .palette-box.unanswered {
            background-color: #ef4444; /* Red */
            color: #ffffff;
        }

        .palette-box.answered {
            background-color: #22c55e; /* Green */
            color: #ffffff;
        }

        /* Results Page Styles */
        .results-container { /* This class is not used, but styles below target elements within #final-results-page */
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-top: 20px;
            text-align: center;
        }

        .results-detail {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .results-detail strong {
            color: #4f46e5;
        }

        .telegram-link {
            color: #4f46e5;
            text-decoration: underline;
            font-weight: 600;
            margin-top: 20px;
            display: inline-block;
        }

        /* Admin Section Styles (Updated for internal positioning) */
        .admin-section {
            text-align: center;
            width: 100%; /* Take full width of parent */
            padding-top: 20px; /* Space from elements above it */
            margin-top: 20px; /* Space from elements above it */
            border-top: 1px solid #e2e8f0; /* Separator */
            background-color: #f8fafc; /* Light background */
            border-radius: 0 0 16px 16px; /* Match container bottom radius */
            padding-bottom: 10px; /* Padding at the bottom */
        }

        .admin-section h3 {
            font-size: 0.8rem; /* Smaller heading */
            font-weight: 700;
            margin-bottom: 10px; /* Smaller margin */
            color: #4f46e5;
        }

        .admin-login-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; /* Smaller gap */
        }

        /* Specific styles for admin input and button */
        .admin-login-area input.input-field {
            width: 80%; /* Take full width of its container */
            max-width: 200px; /* Smaller max-width */
            font-size: 0.85rem; /* Smaller font */
            padding: 8px 10px; /* Smaller padding */
            margin-bottom: 0; /* Remove bottom margin as gap handles spacing */
        }

        .admin-login-area button.action-button {
            padding: 8px 16px; /* Smaller padding */
            font-size: 0.85rem; /* Smaller font size */
        }

        .admin-login-message {
            color: #ef4444;
            font-weight: 500;
            margin-top: 5px;
            margin-bottom: 0;
            font-size: 0.75rem;
        }

        /* Admin Results Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 800px; /* Slightly narrower than full admin page */
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling for content */
            position: relative;
            text-align: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 25px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2.5rem;
            color: #666;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .close-button:hover {
            color: #333;
        }

        /* Styles for the table inside the modal */
        .admin-results-table-wrapper {
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto; /* Ensure horizontal scroll on small screens */
        }

        .admin-results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            text-align: left;
        }

        .admin-results-table th,
        .admin-results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .admin-results-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .admin-results-table tbody tr:hover {
            background-color: #f0f2f5;
        }

        .admin-results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .loading-message, .error-message, .no-results-message {
            font-size: 1.1rem;
            color: #6b7280;
            margin-top: 20px;
        }

        .error-message {
            color: #ef4444;
            font-weight: 600;
        }

        /* Footer */
        .app-footer {
            position: absolute;
            bottom: 10px; /* Keep it slightly above the very bottom */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #9ca3af; /* Grey color */
            user-select: none; /* Prevent selection for integrity check */
            white-space: nowrap; /* Keep on one line */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            #quiz-page {
                grid-template-columns: 1fr; /* Stack main content and sidebar */
            }
            #quiz-sidebar {
                order: -1; /* Move sidebar to top on small screens */
                margin-bottom: 20px;
            }
            .quiz-container {
                padding: 24px;
                margin: 10px;
            }
            .question-text {
                font-size: 1.5rem;
            }
            .option-button, .quiz-nav-button, .action-button {
                font-size: 1rem;
                padding: 12px 16px;
            }
            .quiz-nav-buttons {
                flex-wrap: wrap; /* Allow buttons to wrap */
                justify-content: center;
            }
            .quiz-nav-button {
                flex-basis: 48%; /* Make buttons take roughly half width when wrapped */
            }
            .notice-title {
                font-size: 1.75rem;
            }
            .notice-list li {
                font-size: 1rem;
            }
            .admin-section {
                position: static; /* Remove absolute positioning on small screens */
                width: auto; /* Allow it to take full width */
                margin-top: 30px; /* Add some top margin */
                padding: 20px;
                box-shadow: none; /* Remove shadow to blend better */
                border-top: 1px solid #e2e8f0; /* Add border back */
                border-radius: 0; /* Remove border radius */
            }
            .admin-login-area input.input-field {
                max-width: 100%; /* Allow full width */
            }
            /* Responsive adjustments for modal */
            .modal-content {
                padding: 20px;
                width: 95%; /* Adjust width for smaller screens */
            }
            .modal-title {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
            .admin-results-table th,
            .admin-results-table td {
                padding: 8px 10px;
                font-size: 0.75rem; /* Smaller font in table for mobile */
            }
            .close-button {
                font-size: 2rem;
                top: 10px;
                right: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="quiz-app" class="quiz-container">
        <div id="login-page" class="page-content">
            <h2 class="question-text">Welcome to the Quiz!</h2>
            <p class="mb-4">Please enter your name to begin.</p>
            <input type="text" id="student-name-input" class="input-field" placeholder="Your Name">
            <button id="start-quiz-button" class="action-button" disabled>START</button>

            <div class="admin-section">
                <h3>Admin Login</h3>
                <div class="admin-login-area">
                    <input type="password" id="admin-passcode-input" class="input-field" placeholder="Enter Admin Passcode">
                    <button id="admin-login-button" class="action-button">Login as Admin</button>
                    <p id="admin-login-message" class="admin-login-message hidden"></p>
                </div>
            </div>
        </div>

        <div id="notice-page" class="page-content hidden">
            <h2 class="notice-title">IMPORTANT NOTICE</h2>
            <ul class="notice-list">
                <li>Each question carries <strong>2 marks</strong>.</li>
                <li>There will be <strong><span style="font-size: 1.2em;">NEGATIVE MARKING</span></strong> for incorrect answers.</li>
                <li>Penalty for incorrect answer is <strong>0.5 marks (25%)</strong>.</li>
                <li>Remember to click <span class="text-red-500 font-bold">Save & Next</span> to confirm your answer.</li>
            </ul>
            <button id="continue-quiz-button" class="action-button">Continue</button>
        </div>

        <div id="quiz-page" class="hidden">
            <div id="timer-display">05:00</div>
            <div id="quiz-main-content">
                <img id="question-image" class="question-image hidden" alt="Question Image">
                <h2 id="question-text" class="question-text"></h2>
                <div id="options-container" class="options-container">
                    </div>
                <div class="quiz-nav-buttons">
                    <button id="save-next-button" class="quiz-nav-button save-next">Save & Next</button>
                    <button id="clear-button" class="quiz-nav-button clear">Clear</button>
                    <button id="next-button" class="quiz-nav-button next">Next</button>
                </div>
                <div class="answer-key-nav-buttons hidden">
                    <button id="prev-answer-key-button" class="answer-key-nav-button">Previous</button>
                    <button id="next-answer-key-button" class="answer-key-nav-button">Next</button>
                </div>
            </div>
            <div id="quiz-sidebar">
                <div class="legend-box">
                    <h3 class="font-bold text-lg mb-3">Legend</h3>
                    <div class="legend-item">
                        <div class="legend-color-box red-ball"><i class="fas fa-circle"></i></div>
                        <span>Unanswered Questions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box grey"></div>
                        <span>Not Visited Questions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color-box green"></div>
                        <span>Answered Questions</span>
                    </div>
                </div>
                <div id="question-palette">
                    </div>
            </div>
        </div>

        <div id="final-results-page" class="page-content hidden">
            <h2 class="question-text">Quiz Results for <span id="student-name-display"></span></h2>
            <p class="results-detail">Questions Attempted: <strong id="attempted-display">0</strong></p>
            <p class="results-detail">Correct Answers: <strong id="correct-display">0</strong></p>
            <p class="results-detail">Incorrect Answers: <strong id="incorrect-display">0</strong></p>
            <p class="results-detail text-2xl mt-4">Total Score: <strong id="final-score-display">0</strong></p>
            <p class="results-detail">Maximum Marks: <strong id="max-marks-display">0</strong></p>
            <button id="show-answer-key-button" class="action-button mt-4">Answer Key</button>
        </div>

        <div id="admin-results-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="close-admin-modal" class="close-button">&times;</button>
                <h2 class="modal-title">All Quiz Results</h2>
                <div id="admin-results-display-area" class="admin-results-table-wrapper">
                    <p class="loading-message">Loading results...</p>
                    </div>
            </div>
        </div>

        <div id="app-footer" class="app-footer">betabiosciences@gmail.com</div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyCQMXeU6OJw2e5A-tPQFeoi8MO8ZZfY0WQ",
            authDomain: "beta-quizapp.firebaseapp.com",
            projectId: "beta-quizapp",
            storageBucket: "beta-quizapp.appspot.com",
            messagingSenderId: "709439478022",
            appId: "1:709439478022:web:595f257edbade7d458a687",
            measurementId: "G-5WF35EM4YB"
        };

        const projectIdForFirestorePath = firebaseConfig.projectId;

        let app, db, auth, userId;
        let isAuthReady = false;

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        isAuthReady = true;
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Firebase Anonymous Auth failed:", error);
                            adminLoginMessage.textContent = "Firebase authentication failed. Cannot load results.";
                            adminLoginMessage.classList.remove('hidden');
                            adminLoginMessage.style.color = '#ef4444';
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                adminLoginMessage.textContent = "Firebase initialization failed. Cannot load results.";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#ef4444';
            }
        }
        initFirebase();

        // --- Quiz Data ---
        const quizData = [
            {
        question: "What parameter, plotted on Y-axis against generation time, would yield the curve shown in the figure?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig1.png",
        options: [
            "A. Survivorship",
            "B. Body size",
            "C. Lifespan",
            "D. Intrinsic rate of growth"
        ],
        correctAnswer: "D. Intrinsic rate of growth"
    },
    {
        question: "Three important biological parameters - generation time, population growth rate (r) and metabolic rate per gram body weight are a function of the organism's body size. Which of the curves (a) or (b) represents the correct relation of each of the parameters to body size?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig2.png",
        options: [
            "A. Generation time - (a); population growth rate - (b); metabolic rate/g bw - (a)",
            "B. Generation time - (a); population growth rate - (b); metabolic rate/g bw - (b)",
            "C. Generation time - (b); population growth rate - (a); metabolic rate/g bw - (a)",
            "D. Generation time - (b); population growth rate - (b); metabolic rate/g bw - (a)"
        ],
        correctAnswer: "C. Generation time - (b); population growth rate - (a); metabolic rate/g bw - (a)"
    },
    {
        question: "The graph below shows the relationships of per capita population growth rate (r), fecundity (b) and age at first reproduction (alpha) in an animal species. What is the most important conclusion to be drawn from the graph?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig3.png",
        options: [
            "A. The later the age of first reproduction, the lower is the population growth rate achieved.",
            "B. The population growth rate decreases as first reproduction is postponed to a later stage, regardless of the fecundity.",
            "C. At any alpha, the higher the fecundity, the higher is the population growth rate achieved.",
            "D. As the age at first reproduction is postponed further, the benefits of increasing fecundity on the population growth rate become progressively negligible."
        ],
        correctAnswer: "D. As the age at first reproduction is postponed further, the benefits of increasing fecundity on the population growth rate become progressively negligible."
    },
    {
        question: "An observation was made on a species experiencing three factors A, B and C in order to infer a density dependent population regulation by a factor. The following graph shows the relationship between the adverse effect of the factors in terms of number and population density. Based on the above observation, which of the following is correct?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig4.png",
        options: [
            "A. A - Density independent; B - Density dependent; C - Inversely density dependent",
            "B. A - Inversely density dependent; B - Density independent; C - Density dependent",
            "C. A - Density dependent; B - Inversely density independent; C - Density independent",
            "D. A - Density dependent; B - Density independent; C - Inversely density dependent"
        ],
        correctAnswer: "B. A - Inversely density dependent; B - Density independent; C - Density dependent"
    },
    {
        question: "The birth rates (b) and death rates (d) of two - species 1 and 2 in relation to population density (N) are shown in the graphs. Which of the following is NOT true about the density-dependent effects on birth rates and death rates?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig5.png",
        options: [
            "A. Birth rates are density-dependent in species 1 and density-independent in species 2",
            "B. Death rates are density-dependent in both the species.",
            "C. Density-dependent effect on birth rate is stronger in species 1 than in species 2.",
            "D. The density-dependent effects on death rates are similar in both the species."
        ],
        correctAnswer: "D. The density-dependent effects on death rates are similar in both the species."
    },
    {
        question: "Which of the following statements about the birth rates (b1, b2) and death rates (d1, d2) of species 1 and 2 indicated in the figure is NOT true?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig6.png",
        options: [
            "A. Birth rates of species 1 are density independent.",
            "B. Death rates of both species are density dependent.",
            "C. Birth rates of species 2 are density dependent.",
            "D. Density dependent effects on death rates are similar for both the species."
        ],
        correctAnswer: "D. Density dependent effects on death rates are similar for both the species."
    },
    {
        question: "Two lakes (I and II) with a similar trophic structure of phytoplankton-zooplankton, planktivorous fish food chain were chosen. To understand the 'top-down' effects, some piscivorous fish (those that feed on planktivorous fish) were introduced into Lake I, making it a system with four trophic levels. Lake II was enriched by adding large quantities of nitrates and phosphates to study the 'bottom-up' effects over a period of time. Changes in the biomasses of each trophic level were measured. The expected major changes in the two lakes are",
        options: [
            "A. In Lake I zooplankton biomass increases, phytoplankton biomass decreases. In Lake II both phytoplankton and planktivorous fish biomasses increase.",
            "B. In Lake I zooplankton biomass decreases, phytoplankton biomass increases. In Lake II both phytoplankton and planktivorous fish biomasses increase.",
            "C. In Lake I planktivorous fish biomass and phytoplankton biomass decrease. In Lake II phytoplankton biomass increases, planktivorous fish biomass decreases.",
            "D. In Lake I planktivorous fish and zooplankton biomasses increase. In Lake II both phytoplankton and planktivorous fish biomasses increase."
        ],
        correctAnswer: "A. In Lake I zooplankton biomass increases, phytoplankton biomass decreases. In Lake II both phytoplankton and planktivorous fish biomasses increase."
    },
    {
        question: "In a lake ecosystem, bottom-up effects (B) refers to control of a lower trophic level by the higher trophic levels and top down effects (T) refer to the opposite. In a lake with three trophic levels - Phytoplankton ( P), Zooplankton (Z) and Carnivore (C),",
        options: [
            "A. P and C are controlled by B, and Z is controlled by T",
            "B. P, Z and C are all controlled by T",
            "C. P is controlled by B, Z is controlled by T and C is controlled by B",
            "D. P is controlled by T, Z is controlled by B and C is controlled by T"
        ],
        correctAnswer: "C. P is controlled by B, Z is controlled by T and C is controlled by B"
    },
    {
        question: "In a lake, reducing the population of a fish which feeds on plankton was followed by a decline in the rate of primary productivity. This is consistent with which one of the following hypotheses regarding the regulation of primary productivity?",
        options: [
            "A. Bottom-up control",
            "B. Eutrophication",
            "C. Top-down control",
            "D. Trophic pyramid"
        ],
        correctAnswer: "C. Top-down control"
    },
    {
        question: "A small lake has three trophic levels- phytoplankton (autotrophs), Zooplankton (herbivore) and planktivorous fish (primary carnivore). Into this lake, a population of piscivorous fish (secondary carnivore) was introduced to study the 'top-down' effects. What is the expected long-term consequence of such an introduction to phytoplankton and zooplankton trophic levels?",
        options: [
            "A. Zooplankton biomass will increase and phytoplankton biomass will decrease.",
            "B. Zooplankton biomass will decrease and phytoplankton biomass will increase.",
            "C. The biomasses of both zooplankton and phytoplankton will increase.",
            "D. The biomasses of both zooplankton and phytoplankton will decrease."
        ],
        correctAnswer: "A. Zooplankton biomass will increase and phytoplankton biomass will decrease."
    },
    {
        question: "The dynamics of any subpopulation within a metapopulation differs from that of a normal population in that the",
        options: [
            "A. birth rates are lower than the death rates.",
            "B. death rates are lower than the birth rates.",
            "C. immigration and emigration rates are significantly higher.",
            "D. immigration and emigration rates are negligible."
        ],
        correctAnswer: "C. immigration and emigration rates are significantly higher."
    },
    {
        question: "Given below are a set of statements about metapopulation dynamics and habitat conservation. Which one of the following options represents the combination of all correct statements?",
        options: [
            "A. A and C",
            "B. B and C",
            "C. A and D",
            "D. B and D"
        ],
        correctAnswer: "A. A and C"
    },
    {
        question: "What do mayflies, Pacific salmon (Oncorhynchus spp.) and annual grain crops have in common? They all are",
        options: [
            "A. Semelparous",
            "B. Iteroparous",
            "C. Oviparous",
            "D. Viviparous"
        ],
        correctAnswer: "A. Semelparous"
    },
    {
        question: "Which of the following is NOT semelparous?",
        options: [
            "A. Dracena",
            "B. Bamboo",
            "C. Cicada",
            "D. Mayfly"
        ],
        correctAnswer: "A. Dracena"
    },
    {
        question: "A specialist species has a",
        options: [
            "A. wider niche and high efficiency of niche utilization",
            "B. narrower niche and high efficiency of niche utilization",
            "C. wider niche and low efficiency of niche utilization",
            "D. narrower niche and low efficiency of niche utilization"
        ],
        correctAnswer: "B. narrower niche and high efficiency of niche utilization"
    },
    {
        question: "One life history trait that is not characteristic of very small sized organisms is",
        options: [
            "A. delayed age at first reproduction.",
            "B. earlier age at first reproduction.",
            "C. high population growth rate.",
            "D. short lifespan."
        ],
        correctAnswer: "A. delayed age at first reproduction."
    },
    {
        question: "A species whose life history strategies allow for high intrinsic rates of increase (r - strategist) will also exhibit the following EXCEPT",
        options: [
            "A. high tolerance for both environmental instability and low-quality resources.",
            "B. short period of exponential population growth (r)",
            "C. reproductive strategy that involves random mating, semelparity and little or no parental investment",
            "D. survivorship that show density-dependent mortality, typically exhibiting Type I or 2 survivorship curves."
        ],
        correctAnswer: "D. survivorship that show density-dependent mortality, typically exhibiting Type I or 2 survivorship curves."
    },
    {
        question: "Compared to K-selection, r-selection favours",
        options: [
            "A. rapid development, smaller body size and early, semelparous reproduction.",
            "B. rapid development, smaller body size and early, iteroparous reproduction.",
            "C. slow development, larger body size and late, iteroparous reproduction.",
            "D. slow development, smaller body size and late, iteroparous reproduction"
        ],
        correctAnswer: "A. rapid development, smaller body size and early, semelparous reproduction."
    },
    {
        question: "Which one of the following trait set characterizes best a r selected species?",
        options: [
            "A. Usually a type III survivorship curve, short life span and density dependent mortality",
            "B. Usually a type I survivorship curve, short life span and density dependent mortality",
            "C. Usually a type I survivorship curve, long life span and density independent mortality",
            "D. Usually a type III survivorship curve, short life span and density independent mortality"
        ],
        correctAnswer: "D. Usually a type III survivorship curve, short life span and density independent mortality"
    },
    {
        question: "A hormone facilitates oogenesis in mammals. The same hormone down regulates the transfer of nutrients from the placenta. The likely effect of the hormone on life history strategies is that it facilitates",
        options: [
            "A. 'r' type of reproduction.",
            "B. 'K' type of reproduction.",
            "C. both 'r' and 'K' reproduction.",
            "D. neither 'r' nor 'K' reproduction."
        ],
        correctAnswer: "A. 'r' type of reproduction."
    },
    {
        question: "The most important reproductive strategies of big trees in a forest are",
        options: [
            "A. earlier age at first reproduction and production of a large number of small seeds.",
            "B. earlier age at first reproduction and production of a small number of large seeds.",
            "C. later age at first reproduction and production of a large number of small seeds.",
            "D. later age at first reproduction and production of a small number of large seeds."
        ],
        correctAnswer: "D. later age at first reproduction and production of a small number of large seeds."
    },
    {
        question: "Which one of the following statements supports the concepts of trade-off in the evolution of life history traits?",
        options: [
            "A. Level of parental care and clutch size are positively correlated.",
            "B. Animals mature in early tend to live longer",
            "C. An increase in the seed size is usually associated with the decrease in the seed number.",
            "D. Allocation of higher energy for reproduction leads to higher population growth"
        ],
        correctAnswer: "C. An increase in the seed size is usually associated with the decrease in the seed number."
    },
    {
        question: "In life history evolution there is generally a tradeoff between the size and number of offsprings produced. Some conditions are listed below. What are the above two conditions that would favour the production of a small number of large-sized offspring?",
        options: [
            "A. B and C",
            "B. B and D",
            "C. A and B",
            "D. A and C"
        ],
        correctAnswer: "C. A and B"
    },
    {
        question: "Suppose you discovered a new species about which you know only two facts: it is small sized (<10 cm) and short lived (<20 days). Which of the following strategies is most likely to be true for this species?",
        options: [
            "A. Breed early and more than once in life and produces large number of small sized offspring",
            "B. Breed late and only once in life and produces large number of small sized offspring",
            "C. Breed early and only once in life and produces large number of small sized offspring",
            "D. Breed early and only once in life and produces small number of large sized offspring"
        ],
        correctAnswer: "C. Breed early and only once in life and produces large number of small sized offspring"
    },
    {
        question: "There are three species of frogs - A, B and C. Species A does not provide parental care for its eggs and larvae. Species B is subjected to predation by a predator that selectively feeds only on small-sized larvae. Species C faces progressively decreasing opportunities for breeding with increasing age. Assuming that resources available for reproduction are similar for A, B and C. Which of the following strategies would have been favored?",
        options: [
            "A. A should produce large number of small-sized offspring; B should produce a small number of large-sized offspring; C should breed earlier in life.",
            "B. Species A and B should produce a small number, of large-sized offspring and C should breed earlier in life.",
            "C. Both species A and B should produce a large number of small-sized offspring and C should breed later in life but increase its clutch size.",
            "D. Species A should produce a small number of large-sized offspring; B should produce a large number of small sized offspring and C should breed earlier in life with a small clutch size."
        ],
        correctAnswer: "A. A should produce large number of small-sized offspring; B should produce a small number of large-sized offspring; C should breed earlier in life."
    },
    {
        question: "In a particular population A, individuals are under stress and thus produce smaller offspring. Based on this, one may conclude that",
        options: [
            "A. stress in a population affects offspring size but not the number of offspring.",
            "B. stressed adults prefer to produce smaller offspring that require less food.",
            "C. stress may be linked to offspring size.",
            "D. stress in a population directly affects offspring size."
        ],
        correctAnswer: "C. stress may be linked to offspring size."
    },
    {
        question: "Which of the following life history traits is most likely in a rodent species when snakes prefer to prey upon large, older individuals of the rodent species that grow continuously over their lifespan?",
        options: [
            "A. Early reproduction and slow growth rate",
            "B. Delayed reproduction and fast growth rate,",
            "C. Delayed reproduction and slow growth rate,",
            "D. Early reproduction and fast growth rate,"
        ],
        correctAnswer: "A. Early reproduction and slow growth rate"
    },
    {
        question: "Some of the statements given below are related to species that show r- or k-selection strategies. Choose the option that contains all the correct statements related to r- and k-selection strategies.",
        options: [
            "A. A and B only",
            "B. A, B and C only",
            "C. C, D, and E only",
            "D. A, B, C and E only"
        ],
        correctAnswer: "D. A, B, C and E only"
    },
    {
        question: "Given below are the population pyramids of three different populations A, B and C depicting the relationship between birth and death rates in each. Based on the population pyramids given above, which one of the following is INCORRECT?",
        image: "https://betabiosciences.github.io//Other-Units/Exam%2013%20Population%20ecology%20fig7.png",
        options: [
            "A. Population B has slower growth rate than population A.",
            "B. Population C has birth rate higher than its death rate.",
            "C. Population A represent a rapidly growing population.",
            "D. Population B has the highest death rate among the three populations."
        ],
        correctAnswer: "B. Population C has birth rate higher than its death rate."
            }
        ];

        // --- Quiz Configuration ---
        const questionMarks = 2;
        const negativeMarkingValue = 0.5;
        const quizDuration = 25 * 60;
        const currentQuizVersion = "Population_Ecology_v3.0"; // Updated quiz version

        // --- HTML Element References ---
        const loginPage = document.getElementById('login-page');
        const studentNameInput = document.getElementById('student-name-input');
        const startQuizButton = document.getElementById('start-quiz-button');

        const noticePage = document.getElementById('notice-page');
        const continueQuizButton = document.getElementById('continue-quiz-button');

        const quizPage = document.getElementById('quiz-page');
        const timerDisplay = document.getElementById('timer-display');
        const questionImage = document.getElementById('question-image');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const saveNextButton = document.getElementById('save-next-button');
        const clearButton = document.getElementById('clear-button');
        const nextButton = document.getElementById('next-button');
        const quizNavButtons = document.querySelector('.quiz-nav-buttons');
        const questionPalette = document.getElementById('question-palette');
        const quizSidebar = document.getElementById('quiz-sidebar');

        const finalResultsPage = document.getElementById('final-results-page');
        const studentNameDisplay = document.getElementById('student-name-display');
        const attemptedDisplay = document.getElementById('attempted-display');
        const correctDisplay = document.getElementById('correct-display');
        const incorrectDisplay = document.getElementById('incorrect-display');
        const finalScoreDisplay = document.getElementById('final-score-display');
        const maxMarksDisplay = document.getElementById('max-marks-display');
        const showAnswerKeyButton = document.getElementById('show-answer-key-button');

        const adminPasscodeInput = document.getElementById('admin-passcode-input');
        const adminLoginButton = document.getElementById('admin-login-button');
        const adminLoginMessage = document.getElementById('admin-login-message');

        const adminResultsModal = document.getElementById('admin-results-modal');
        const adminResultsDisplayArea = document.getElementById('admin-results-display-area');
        const closeAdminModalButton = document.getElementById('close-admin-modal');

        const appFooter = document.getElementById('app-footer');

        // New Answer Key Navigation Buttons
        const answerKeyNavButtons = document.querySelector('.answer-key-nav-buttons');
        const prevAnswerKeyButton = document.getElementById('prev-answer-key-button');
        const nextAnswerKeyButton = document.getElementById('next-answer-key-button');

        // --- Quiz State Variables ---
        let studentName = '';
        let currentQuestionIndex = 0;
        // 0: Not visited, 1: Visited but not answered (red), 2: Answered (green)
        let questionStatus = Array(quizData.length).fill(0);
        let savedAnswers = Array(quizData.length).fill(null);
        let timeLeft = quizDuration;
        let timerInterval;
        let quizSubmitted = false;
        let isAnswerKeyMode = false;

        window.selectedAnswer = null;

        // --- Integrity Check ---
        const expectedFooterText = "betabiosciences@gmail.com";
        function checkFooterIntegrity() {
            if (appFooter && appFooter.textContent !== expectedFooterText) {
                console.error("Integrity check failed: Footer text modified!");
                clearInterval(timerInterval);
                [startQuizButton, continueQuizButton, saveNextButton, clearButton, nextButton, adminLoginButton, showAnswerKeyButton, prevAnswerKeyButton, nextAnswerKeyButton].forEach(btn => {
                    if (btn) btn.disabled = true;
                });
                const body = document.querySelector('body');
                const alertDiv = document.createElement('div');
                alertDiv.style.position = 'fixed';
                alertDiv.style.top = '20px';
                alertDiv.style.left = '50%';
                alertDiv.style.transform = 'translateX(-50%)';
                alertDiv.style.backgroundColor = 'red';
                alertDiv.style.color = 'white';
                alertDiv.style.padding = '15px';
                alertDiv.style.borderRadius = '8px';
                alertDiv.style.zIndex = '2000';
                alertDiv.textContent = "Quiz functionality has been disabled due to an integrity check failure. Please do not modify the footer text.";
                body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 5000);
                return false;
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkFooterIntegrity, 100);
        });


        // --- Page Navigation Functions ---
        function showPage(pageElement) {
            [loginPage, noticePage, quizPage, finalResultsPage].forEach(page => {
                if (page) page.classList.add('hidden');
            });
            if (pageElement) pageElement.classList.remove('hidden');
        }

        function showModal(modalElement) {
            if (modalElement) modalElement.classList.remove('hidden');
        }

        function hideModal(modalElement) {
            if (modalElement) modalElement.classList.add('hidden');
        }


        // --- Login Page Logic ---
        studentNameInput.addEventListener('input', () => {
            startQuizButton.disabled = studentNameInput.value.trim() === '';
        });

        startQuizButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            studentName = studentNameInput.value.trim();
            if (studentName) {
                showPage(noticePage);
            }
        });

        // --- Notice Page Logic ---
        continueQuizButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            showPage(quizPage);
            startTimer();
            loadQuestion(currentQuestionIndex);
            renderQuestionPalette();
            quizNavButtons.classList.remove('hidden');
            answerKeyNavButtons.classList.add('hidden');
            timerDisplay.classList.remove('hidden');
            quizSidebar.classList.remove('hidden');
        });

        // --- Timer Logic ---
        function startTimer() {
            timerInterval = setInterval(() => {
                if (!checkFooterIntegrity()) {
                    clearInterval(timerInterval);
                    return;
                }
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuizAutomatically();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            timerDisplay.classList.remove('orange', 'red', 'green');
            if (timeLeft <= 60) {
                timerDisplay.classList.add('red');
            } else if (timeLeft <= 180) {
                timerDisplay.classList.add('orange');
            } else {
                timerDisplay.classList.add('green');
            }
        }

        function submitQuizAutomatically() {
            if (!quizSubmitted) {
                const body = document.querySelector('body');
                const alertDiv = document.createElement('div');
                alertDiv.style.position = 'fixed';
                alertDiv.style.top = '20px';
                alertDiv.style.left = '50%';
                alertDiv.style.transform = 'translateX(-50%)';
                alertDiv.style.backgroundColor = '#f59e0b';
                alertDiv.style.color = 'white';
                alertDiv.style.padding = '15px';
                alertDiv.style.borderRadius = '8px';
                alertDiv.style.zIndex = '2000';
                alertDiv.textContent = "Time's up! Your quiz has been automatically submitted.";
                body.appendChild(alertDiv);
                setTimeout(() => alertDiv.remove(), 3000);
                submitQuiz();
            }
        }

        // --- Quiz Page Logic ---
        function loadQuestion(index) {
            if (!checkFooterIntegrity()) return;
            currentQuestionIndex = index;
            optionsContainer.innerHTML = '';
            window.selectedAnswer = savedAnswers[currentQuestionIndex]; // Load previously selected answer

            const currentQuestion = quizData[currentQuestionIndex];
            questionText.textContent = `Q${index + 1}: ${currentQuestion.question}`;

            // Handle question image
            if (currentQuestion.image) {
                questionImage.src = currentQuestion.image;
                questionImage.alt = `Image for question ${index + 1}`;
                questionImage.classList.remove('hidden');
                
                // Add error handling for images
                questionImage.onerror = function() {
                    this.classList.add('hidden');
                    console.error("Failed to load question image");
                };
            } else {
                questionImage.classList.add('hidden');
            }

            currentQuestion.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');

                if (isAnswerKeyMode) {
                    const cleanedOption = option.replace(/^[A-D]\)\s*/, '');
                    const cleanedCorrectAnswer = currentQuestion.correctAnswer.replace(/^[A-D]\)\s*/, '');
                    const cleanedStudentAnswer = savedAnswers[currentQuestionIndex] ? savedAnswers[currentQuestionIndex].replace(/^[A-D]\)\s*/, '') : null;

                    if (cleanedOption === cleanedCorrectAnswer) {
                        button.classList.add('correct-answer');
                    }
                    if (cleanedStudentAnswer === cleanedOption && cleanedOption !== cleanedCorrectAnswer) {
                        button.classList.add('incorrect-answer');
                    }
                    button.classList.add('disabled-for-answer-key');
                } else {
                    if (savedAnswers[currentQuestionIndex] === option) {
                        button.classList.add('selected');
                    }
                    button.addEventListener('click', () => selectAnswer(button, option));
                }
                optionsContainer.appendChild(button);
            });

            if (!isAnswerKeyMode) {
                // IMPORTANT FIX: Mark as visited (red) if not already answered
                if (questionStatus[currentQuestionIndex] === 0) {
                    questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                }
                updateQuestionPalette();

                if (currentQuestionIndex === quizData.length - 1) {
                    nextButton.textContent = 'Submit Quiz';
                    nextButton.classList.add('submit-quiz');
                    nextButton.classList.remove('next');
                } else {
                    nextButton.textContent = 'Next';
                    nextButton.classList.remove('submit-quiz');
                    nextButton.classList.add('next');
                }
            } else {
                prevAnswerKeyButton.disabled = (currentQuestionIndex === 0);
                nextAnswerKeyButton.classList.add('answer-key-nav-button');
                if (currentQuestionIndex === quizData.length - 1) {
                    nextAnswerKeyButton.textContent = 'Close Answer Key';
                    nextAnswerKeyButton.classList.add('close-answer-key');
                } else {
                    nextAnswerKeyButton.textContent = 'Next';
                    nextAnswerKeyButton.classList.remove('close-answer-key');
                }
            }
        }

        function selectAnswer(button, optionText) {
            if (!checkFooterIntegrity()) return;
            document.querySelectorAll('.option-button.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            window.selectedAnswer = optionText;
        }

        saveNextButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (window.selectedAnswer !== null) {
                savedAnswers[currentQuestionIndex] = window.selectedAnswer;
                questionStatus[currentQuestionIndex] = 2; // Mark as answered (green)
            } else {
                // If Save & Next is clicked without selecting an answer, it remains 'visited but unanswered' or 'not visited'
                // For 'Save & Next', we assume intent to save (even if null) and move on.
                // If it was already green (answered), it stays green. If red, it stays red. If grey, it becomes red.
                 if (questionStatus[currentQuestionIndex] === 0) { // If not visited
                     questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                 }
            }
            moveToNextQuestion();
        });

        clearButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            window.selectedAnswer = null;
            savedAnswers[currentQuestionIndex] = null;
            document.querySelectorAll('.option-button.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
            updateQuestionPalette();
        });

        nextButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;

            // If "Next" is clicked:
            // 1. If an answer is selected, mark as answered (green).
            // 2. If no answer is selected but the question was previously green (answered), it remains green.
            // 3. If no answer is selected and it was grey (not visited) or red (visited but not answered), it becomes red.
            if (window.selectedAnswer !== null) {
                 savedAnswers[currentQuestionIndex] = window.selectedAnswer;
                 questionStatus[currentQuestionIndex] = 2; // Mark as answered (green)
            } else {
                 if (questionStatus[currentQuestionIndex] === 0 || questionStatus[currentQuestionIndex] === 1) {
                     questionStatus[currentQuestionIndex] = 1; // Mark as visited but unanswered (red)
                 }
            }

            if (currentQuestionIndex === quizData.length - 1) {
                submitQuiz();
            } else {
                moveToNextQuestion();
            }
        });

        function moveToNextQuestion() {
            if (currentQuestionIndex < quizData.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                console.log("Already on the last question. Consider submitting.");
            }
        }

        function renderQuestionPalette() {
            questionPalette.innerHTML = '';
            quizData.forEach((_, index) => {
                const box = document.createElement('div');
                box.classList.add('palette-box');
                box.textContent = index + 1;
                box.addEventListener('click', () => loadQuestion(index));
                questionPalette.appendChild(box);
            });
            updateQuestionPalette();
        }

        function updateQuestionPalette() {
            const paletteBoxes = questionPalette.children;
            if (paletteBoxes.length !== quizData.length) {
                console.warn("Palette boxes count mismatch with quiz data. Re-rendering palette.");
                renderQuestionPalette();
                return;
            }
            questionStatus.forEach((status, index) => {
                const box = paletteBoxes[index];
                if (box) {
                    box.classList.remove('unanswered', 'answered', 'grey'); // Remove all states first
                    if (status === 1) { // Visited but not answered (red)
                        box.classList.add('unanswered');
                    } else if (status === 2) { // Answered (green)
                        box.classList.add('answered');
                    } else { // Not visited (grey)
                        box.classList.add('grey');
                    }
                }
            });
        }

        // --- Final Submission and Results Logic ---
        async function submitQuiz() {
            if (!checkFooterIntegrity()) return;
            if (quizSubmitted) return;
            quizSubmitted = true;
            clearInterval(timerInterval);

            let correctAnswersCount = 0;
            let incorrectAnswersCount = 0;
            let attemptedQuestionsCount = 0;
            let finalScore = 0;

            quizData.forEach((question, index) => {
                const studentAnswer = savedAnswers[index];
                if (studentAnswer !== null) {
                    attemptedQuestionsCount++;
                    const cleanedStudentAnswer = studentAnswer.replace(/^[A-D]\)\s*/, '');
                    const cleanedCorrectAnswer = question.correctAnswer.replace(/^[A-D]\)\s*/, '');

                    if (cleanedStudentAnswer === cleanedCorrectAnswer) {
                        correctAnswersCount++;
                        finalScore += questionMarks;
                    } else {
                        incorrectAnswersCount++;
                        finalScore -= negativeMarkingValue;
                    }
                }
            });

            studentNameDisplay.textContent = studentName;
            attemptedDisplay.textContent = attemptedQuestionsCount;
            correctDisplay.textContent = correctAnswersCount;
            incorrectDisplay.textContent = incorrectAnswersCount;
            finalScoreDisplay.textContent = finalScore.toFixed(1);

            const maxPossibleMarks = quizData.length * questionMarks;
            maxMarksDisplay.textContent = maxPossibleMarks;

            showPage(finalResultsPage);

            if (isAuthReady && db && userId) {
                try {
                    const resultsCollectionRef = collection(db, `quizzes/${projectIdForFirestorePath}/results`);
                    const submissionId = `${userId}_${Date.now()}`;
                    await setDoc(doc(resultsCollectionRef, submissionId), {
                        studentName: studentName,
                        score: parseFloat(finalScore.toFixed(1)),
                        attemptedQuestions: attemptedQuestionsCount,
                        correctAnswers: correctAnswersCount,
                        incorrectAnswers: incorrectAnswersCount,
                        maxMarks: maxPossibleMarks,
                        timestamp: serverTimestamp(),
                        userId: userId,
                        quizVersion: currentQuizVersion
                    });
                    console.log("Quiz results saved to Firestore!");
                } catch (e) {
                    console.error("Error adding document to Firestore: ", e);
                    const resultsPage = document.getElementById('final-results-page');
                    let saveErrorMsg = document.getElementById('saveErrorMsg');
                    if (!saveErrorMsg) {
                        saveErrorMsg = document.createElement('p');
                        saveErrorMsg.id = 'saveErrorMsg';
                        saveErrorMsg.style.color = 'red';
                        saveErrorMsg.style.marginTop = '10px';
                        resultsPage.insertBefore(saveErrorMsg, document.querySelector('.telegram-link'));
                    }
                    saveErrorMsg.textContent = "Note: Could not save results to the server. Please ensure you are connected to the internet.";
                }
            } else {
                console.warn("Firestore not ready or user not authenticated. Results not saved.");
                const resultsPage = document.getElementById('final-results-page');
                let saveErrorMsg = document.getElementById('saveErrorMsg');
                if (!saveErrorMsg) {
                    saveErrorMsg = document.createElement('p');
                    saveErrorMsg.id = 'saveErrorMsg';
                    saveErrorMsg.style.color = 'red';
                    saveErrorMsg.style.marginTop = '10px';
                    resultsPage.insertBefore(saveErrorMsg, document.querySelector('.telegram-link'));
                }
                saveErrorMsg.textContent = "Note: Could not save results to the server. Please ensure you are connected to the internet.";
            }
        }

        // --- Answer Key Logic ---
        showAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            isAnswerKeyMode = true;
            currentQuestionIndex = 0;
            showPage(quizPage);
            loadQuestion(currentQuestionIndex);

            timerDisplay.classList.add('hidden');
            quizNavButtons.classList.add('hidden');
            quizSidebar.classList.add('hidden');

            answerKeyNavButtons.classList.remove('hidden');
        });

        prevAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        });

        nextAnswerKeyButton.addEventListener('click', () => {
            if (!checkFooterIntegrity()) return;
            if (currentQuestionIndex < quizData.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                closeAnswerKey();
            }
        });

        function closeAnswerKey() {
            isAnswerKeyMode = false;
            showPage(finalResultsPage);
            answerKeyNavButtons.classList.add('hidden');
            timerDisplay.classList.add('hidden');
            quizNavButtons.classList.add('hidden');
            quizSidebar.classList.add('hidden');
        }


        // --- Admin Login Logic (Scrambled Passcode) ---
        const obfuscatedPasscodeBytes = [106, 123, 114, 124, 75, 64, 63, 64, 65];
        const baseOffset = 7;

        function getAdminPasscode() {
            let decryptedPasscode = '';
            for (let i = 0; i < obfuscatedPasscodeBytes.length; i++) {
                decryptedPasscode += String.fromCharCode(obfuscatedPasscodeBytes[i] - baseOffset - i);
            }
            return decryptedPasscode;
        }

        adminLoginButton.addEventListener('click', async () => {
            if (!checkFooterIntegrity()) return;
            const enteredPasscode = adminPasscodeInput.value;
            adminLoginMessage.classList.add('hidden');

            if (enteredPasscode === getAdminPasscode()) {
                adminLoginMessage.textContent = "Loading admin results...";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#22c55e';

                await fetchAllQuizResults();
                adminResultsModal.classList.remove('hidden');
                adminLoginMessage.classList.add('hidden');
            } else {
                adminLoginMessage.textContent = "Incorrect passcode.";
                adminLoginMessage.classList.remove('hidden');
                adminLoginMessage.style.color = '#ef4444';
            }
        });

        closeAdminModalButton.addEventListener('click', () => {
            adminResultsModal.classList.add('hidden');
        });

        // --- Fetch and Display All Results for Admin Modal ---
        async function fetchAllQuizResults() {
            adminResultsDisplayArea.innerHTML = '<p class="loading-message">Loading results...</p>';
            if (!isAuthReady || !db) {
                adminResultsDisplayArea.innerHTML = '<p class="error-message">Firebase not ready. Please check configuration and authentication.</p>';
                console.warn("Firestore not ready for admin results fetch.");
                return;
            }

            try {
                const resultsCollectionRef = collection(db, `quizzes/${projectIdForFirestorePath}/results`);
                const q = query(resultsCollectionRef, where("quizVersion", "==", currentQuizVersion));
                const querySnapshot = await getDocs(q);
                const allResults = [];
                querySnapshot.forEach((doc) => {
                    allResults.push({ id: doc.id, ...doc.data() });
                });

                allResults.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                displayAdminResults(allResults);
            } catch (e) {
                console.error("Error fetching all quiz results: ", e);
                adminResultsDisplayArea.innerHTML = `<p class="error-message">Error fetching results: ${e.message}. Check console for details.</p>`;
            }
        }

        function displayAdminResults(results) {
            if (results.length === 0) {
                adminResultsDisplayArea.innerHTML = '<p class="no-results-message">No quiz results found yet.</p>';
                return;
            }

            let tableHtml = `
                <div class="admin-results-table-wrapper">
                    <table class="admin-results-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Score</th>
                                <th>Max Marks</th>
                                <th>Attempted</th>
                                <th>Correct</th>
                                <th>Incorrect</th>
                                <th>Date</th>
                                <th>User ID</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach(result => {
                const date = result.timestamp ? new Date(result.timestamp.toDate()).toLocaleString() : 'N/A';
                tableHtml += `
                    <tr>
                        <td>${result.studentName || 'N/A'}</td>
                        <td>${result.score !== undefined ? result.score.toFixed(1) : 'N/A'}</td>
                        <td>${result.maxMarks !== undefined ? result.maxMarks : (quizData.length * questionMarks)}</td>
                        <td>${result.attemptedQuestions !== undefined ? result.attemptedQuestions : 'N/A'}</td>
                        <td>${result.correctAnswers !== undefined ? result.correctAnswers : 'N/A'}</td>
                        <td>${result.incorrectAnswers !== undefined ? result.incorrectAnswers : 'N/A'}</td>
                        <td>${date}</td>
                        <td>${result.userId || 'N/A'}</td>
                    </tr>
                `;
            });

            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            adminResultsDisplayArea.innerHTML = tableHtml;
        }

        // Initial page load
        document.addEventListener('DOMContentLoaded', () => {
            showPage(loginPage);
        });
    </script>
</body>
</html>